<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>Indigo TestRunner report</title>
<link rel="stylesheet" href="bootstrap.css">
</head>
<body>
<div class="container">
<h1>Host: WINCLONE, time: Tue Jul 01 2014 17:35:21 GMT+0400</h1>
<div class="panel"><h3>Summary:
<span class="text-warning">Coverage: 87.1%</span>
<span class="text-warning">SLOC: 448</span>
<span>Timing: 182 ms.</span>
</h3></div>
<table class="table table-condensed"><tr ><td>1</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>2</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>3</td><td></td><td style="border-top:none;white-space:pre"> * indigo - v0.0.1 - 2014-07-01</td></tr><tr ><td>4</td><td></td><td style="border-top:none;white-space:pre"> * Copyright (c) 2014 ; Licensed MIT</td></tr><tr ><td>5</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr ><td>6</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>7</td><td></td><td style="border-top:none;white-space:pre">#target Illustrator-13</td></tr><tr ><td>8</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>9</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>10</td><td></td><td style="border-top:none;white-space:pre"> * В Indigo собран код, работающий под управлением  </td></tr><tr ><td>11</td><td></td><td style="border-top:none;white-space:pre"> * Adobe Extended Script Tool Kit (`estk`)</td></tr><tr ><td>12</td><td></td><td style="border-top:none;white-space:pre"> * @namespace </td></tr><tr ><td>13</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>14</td><td>1</td><td style="border-top:none;white-space:pre">var Indigo = Indigo || {</td></tr><tr ><td>15</td><td></td><td style="border-top:none;white-space:pre">	</td></tr><tr ><td>16</td><td></td><td style="border-top:none;white-space:pre">	config : {</td></tr><tr ><td>17</td><td></td><td style="border-top:none;white-space:pre">		achtungFile: 'Y:/ACHTUNG.eps',</td></tr><tr ><td>18</td><td></td><td style="border-top:none;white-space:pre">		webaccesslib: [</td></tr><tr ><td>19</td><td></td><td style="border-top:none;white-space:pre">			'C:/Program Files (x86)/Adobe/Adobe Bridge CS3/webaccesslib.dll',</td></tr><tr ><td>20</td><td></td><td style="border-top:none;white-space:pre">			'D:/bin/Adobe/Adobe Bridge CS3/webaccesslib.dll'</td></tr><tr ><td>21</td><td></td><td style="border-top:none;white-space:pre">		],</td></tr><tr ><td>22</td><td></td><td style="border-top:none;white-space:pre">		webserver : 'http://indigo.aicdr.pro:8080/',</td></tr><tr ><td>23</td><td></td><td style="border-top:none;white-space:pre">		// Корень хотфолдеров</td></tr><tr ><td>24</td><td></td><td style="border-top:none;white-space:pre">		HFRoot : 'X:/',</td></tr><tr ><td>25</td><td></td><td style="border-top:none;white-space:pre">		// Корень шаблонов</td></tr><tr ><td>26</td><td></td><td style="border-top:none;white-space:pre">		TmplRoot : 'D:/work/template',</td></tr><tr ><td>27</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr ><td>28</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>29</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>30</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>31</td><td></td><td style="border-top:none;white-space:pre"> * Велосипеды собственной конструкции</td></tr><tr ><td>32</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr ><td>33</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>34</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>35</td><td></td><td style="border-top:none;white-space:pre"> * Округление рационального числа до трёх знаков после запятой</td></tr><tr ><td>36</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>37</td><td></td><td style="border-top:none;white-space:pre"> * @param {number} num </td></tr><tr ><td>38</td><td></td><td style="border-top:none;white-space:pre"> * @return {number}</td></tr><tr ><td>39</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>40</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.round3 = function(num) {</td></tr><tr class="success"><td>41</td><td>2</td><td style="border-top:none;white-space:pre">	return Math.round(num * 1000) / 1000;</td></tr><tr ><td>42</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>43</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>44</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>45</td><td></td><td style="border-top:none;white-space:pre"> * Расширение array методом contains()</td></tr><tr ><td>46</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>47</td><td></td><td style="border-top:none;white-space:pre"> * @example</td></tr><tr ><td>48</td><td></td><td style="border-top:none;white-space:pre"> * [1,2,3].contains[3] === true</td></tr><tr ><td>49</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>50</td><td>1</td><td style="border-top:none;white-space:pre">Array.prototype.contains = function(item) {</td></tr><tr class="success"><td>51</td><td>12</td><td style="border-top:none;white-space:pre">	for (var i = 0, l = this.length; i < l; i++) {</td></tr><tr class="success"><td>52</td><td>16</td><td style="border-top:none;white-space:pre">		if (this[i] === item) { return true; }</td></tr><tr ><td>53</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr class="success"><td>54</td><td>7</td><td style="border-top:none;white-space:pre">	return false;</td></tr><tr ><td>55</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>56</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>57</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>58</td><td></td><td style="border-top:none;white-space:pre"> * Паддинг слева</td></tr><tr ><td>59</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>60</td><td></td><td style="border-top:none;white-space:pre"> * Крадено, чуть подправлено:</td></tr><tr ><td>61</td><td></td><td style="border-top:none;white-space:pre"> * @see http://stackoverflow.com/questions/1267283/how-can-i-create-a-zerofilled-value-using-javascript</td></tr><tr ><td>62</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>63</td><td></td><td style="border-top:none;white-space:pre"> * @param {string} str Исходная строка</td></tr><tr ><td>64</td><td></td><td style="border-top:none;white-space:pre"> * @param {string} ch Символ паддинга</td></tr><tr ><td>65</td><td></td><td style="border-top:none;white-space:pre"> * @param {number} count Длина выходной строки</td></tr><tr ><td>66</td><td></td><td style="border-top:none;white-space:pre"> * @example</td></tr><tr ><td>67</td><td></td><td style="border-top:none;white-space:pre"> * Indigo.lpad('right', '-', 10);</td></tr><tr ><td>68</td><td></td><td style="border-top:none;white-space:pre"> * // returns '-----right'</td></tr><tr ><td>69</td><td></td><td style="border-top:none;white-space:pre"> * @return {string} </td></tr><tr ><td>70</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>71</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.lpad = function(str, ch, count) {</td></tr><tr class="danger"><td>72</td><td>0</td><td style="border-top:none;white-space:pre">	count -= str.toString().length;</td></tr><tr class="danger"><td>73</td><td>0</td><td style="border-top:none;white-space:pre">	if ( count > 0 ) {</td></tr><tr class="danger"><td>74</td><td>0</td><td style="border-top:none;white-space:pre">		return new Array( count + (/\./.test( str ) ? 2 : 1) ).join(ch) + str;</td></tr><tr ><td>75</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr class="danger"><td>76</td><td>0</td><td style="border-top:none;white-space:pre">	return str;</td></tr><tr ><td>77</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>78</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>79</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>80</td><td></td><td style="border-top:none;white-space:pre"> * @class</td></tr><tr ><td>81</td><td></td><td style="border-top:none;white-space:pre"> * @classdesc Суперкласс для сборщиков спусков</td></tr><tr ><td>82</td><td></td><td style="border-top:none;white-space:pre"> * @prop {string} temp Имя шаблона, без расширения .ai</td></tr><tr ><td>83</td><td></td><td style="border-top:none;white-space:pre"> * @prop {string} roll_number Числовой индекс намотки</td></tr><tr ><td>84</td><td></td><td style="border-top:none;white-space:pre"> * @prop {string} hotFolderName Имя "хотфолдера" на RIP </td></tr><tr ><td>85</td><td></td><td style="border-top:none;white-space:pre"> * @prop {array} printList Массив объектов File с этикетками</td></tr><tr ><td>86</td><td></td><td style="border-top:none;white-space:pre"> * @constructor </td></tr><tr ><td>87</td><td></td><td style="border-top:none;white-space:pre"> * @param {object} app Ссылка на объект Adobe Illustrator</td></tr><tr ><td>88</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>89</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.BaseImposer = function(app) {</td></tr><tr class="success"><td>90</td><td>6</td><td style="border-top:none;white-space:pre">	this.illustrator = app;</td></tr><tr class="success"><td>91</td><td>6</td><td style="border-top:none;white-space:pre">	this.illustrator.userInteractionLevel = UserInteractionLevel.DONTDISPLAYALERTS;</td></tr><tr ><td>92</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>93</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>94</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.BaseImposer.prototype = {</td></tr><tr ><td>95</td><td></td><td style="border-top:none;white-space:pre">	/**</td></tr><tr ><td>96</td><td></td><td style="border-top:none;white-space:pre">	 * Инициализация сборки</td></tr><tr ><td>97</td><td></td><td style="border-top:none;white-space:pre">	 * @param {object} job Параметризующий объект с деталями задания</td></tr><tr ><td>98</td><td></td><td style="border-top:none;white-space:pre">	 */</td></tr><tr ><td>99</td><td></td><td style="border-top:none;white-space:pre">	setup: function(job) {</td></tr><tr class="success"><td>100</td><td>8</td><td style="border-top:none;white-space:pre">		this.temp = job.cut_number;</td></tr><tr class="success"><td>101</td><td>8</td><td style="border-top:none;white-space:pre">		this.roll_number = "0"; // логику намоток не помню, так что 0 для проверки; job.roll; //и намотки, которые задаются в окне диалога или выцепляются из базы данных</td></tr><tr class="success"><td>102</td><td>8</td><td style="border-top:none;white-space:pre">		this.hotfolderName = job.hot_folder;</td></tr><tr class="success"><td>103</td><td>8</td><td style="border-top:none;white-space:pre">		this.hotFolder = new Folder (Indigo.config.HFRoot + this.hotfolderName); //Горячая папка</td></tr><tr class="success"><td>104</td><td>8</td><td style="border-top:none;white-space:pre">		this.templateFolder = new Folder (Indigo.config.TmplRoot); //Каталог шаблонов сборки</td></tr><tr class="success"><td>105</td><td>8</td><td style="border-top:none;white-space:pre">		this.printList = job.label_path.split('\n'); //Массив строк из принт-листа</td></tr><tr class="success"><td>106</td><td>8</td><td style="border-top:none;white-space:pre">		this.PDFSettings = new PDFSaveOptions(); // Настройки экспорта в PDF</td></tr><tr class="success"><td>107</td><td>8</td><td style="border-top:none;white-space:pre">		this.PDFSettings.acrobatLayers = false;</td></tr><tr class="success"><td>108</td><td>8</td><td style="border-top:none;white-space:pre">		this.job = job;</td></tr><tr ><td>109</td><td></td><td style="border-top:none;white-space:pre">	},</td></tr><tr ><td>110</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>111</td><td></td><td style="border-top:none;white-space:pre">	/**</td></tr><tr ><td>112</td><td></td><td style="border-top:none;white-space:pre">	 * Возврат ссылки на файл шаблона</td></tr><tr ><td>113</td><td></td><td style="border-top:none;white-space:pre">	 *</td></tr><tr ><td>114</td><td></td><td style="border-top:none;white-space:pre">	 * @return {File} template</td></tr><tr ><td>115</td><td></td><td style="border-top:none;white-space:pre">	 */</td></tr><tr ><td>116</td><td></td><td style="border-top:none;white-space:pre">	getTemplateName: function () {</td></tr><tr class="success"><td>117</td><td>3</td><td style="border-top:none;white-space:pre">		var template = new File (this.templateFolder + '\\short\\' + this.temp + '_short' + '.ai');</td></tr><tr class="success"><td>118</td><td>3</td><td style="border-top:none;white-space:pre">		return template;	</td></tr><tr ><td>119</td><td></td><td style="border-top:none;white-space:pre">	},</td></tr><tr ><td>120</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>121</td><td></td><td style="border-top:none;white-space:pre">	/**</td></tr><tr ><td>122</td><td></td><td style="border-top:none;white-space:pre">	 * Открытие шаблона и сохранение ссылки на него в экземплярной переменной this.template</td></tr><tr ><td>123</td><td></td><td style="border-top:none;white-space:pre">	 *</td></tr><tr ><td>124</td><td></td><td style="border-top:none;white-space:pre">	 * @throws {customException} Нет файла шаблона</td></tr><tr ><td>125</td><td></td><td style="border-top:none;white-space:pre">	 * @return {Document} Активный документ</td></tr><tr ><td>126</td><td></td><td style="border-top:none;white-space:pre">	 */</td></tr><tr ><td>127</td><td></td><td style="border-top:none;white-space:pre">	openTemplate: function() {</td></tr><tr class="success"><td>128</td><td>10</td><td style="border-top:none;white-space:pre">		var templateFile = this.getTemplateName();</td></tr><tr class="success"><td>129</td><td>10</td><td style="border-top:none;white-space:pre">		try {</td></tr><tr class="success"><td>130</td><td>10</td><td style="border-top:none;white-space:pre">			var templateDoc = this.illustrator.open (templateFile); //Открываем шаблон</td></tr><tr class="success"><td>131</td><td>9</td><td style="border-top:none;white-space:pre">			templateDoc.rulerOrigin = [0,0]; //Обнуляем центр координат</td></tr><tr class="success"><td>132</td><td>9</td><td style="border-top:none;white-space:pre">			this.template = templateDoc;</td></tr><tr class="success"><td>133</td><td>9</td><td style="border-top:none;white-space:pre">			return this.template;</td></tr><tr ><td>134</td><td></td><td style="border-top:none;white-space:pre">		} catch (e) {</td></tr><tr ><td>135</td><td></td><td style="border-top:none;white-space:pre">			// interrupt normal flow</td></tr><tr class="success"><td>136</td><td>1</td><td style="border-top:none;white-space:pre">			throw {</td></tr><tr ><td>137</td><td></td><td style="border-top:none;white-space:pre">				message: e.message,</td></tr><tr ><td>138</td><td></td><td style="border-top:none;white-space:pre">				source: 'openTemplate',</td></tr><tr ><td>139</td><td></td><td style="border-top:none;white-space:pre">				file: templateFile.fullName,</td></tr><tr ><td>140</td><td></td><td style="border-top:none;white-space:pre">				severity: 'error',</td></tr><tr ><td>141</td><td></td><td style="border-top:none;white-space:pre">				jobid: this.job.id,</td></tr><tr ><td>142</td><td></td><td style="border-top:none;white-space:pre">			};</td></tr><tr ><td>143</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr ><td>144</td><td></td><td style="border-top:none;white-space:pre">	},</td></tr><tr ><td>145</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>146</td><td></td><td style="border-top:none;white-space:pre">	/**</td></tr><tr ><td>147</td><td></td><td style="border-top:none;white-space:pre">	 * Создание слоя 'Label' под размещение этикеткок</td></tr><tr ><td>148</td><td></td><td style="border-top:none;white-space:pre">	 *</td></tr><tr ><td>149</td><td></td><td style="border-top:none;white-space:pre">	 * @return {Layer} Слой этикеток</td></tr><tr ><td>150</td><td></td><td style="border-top:none;white-space:pre">	 */</td></tr><tr ><td>151</td><td></td><td style="border-top:none;white-space:pre">	setLabelLayer: function() {</td></tr><tr ><td>152</td><td></td><td style="border-top:none;white-space:pre">		// Создаем слой для размещения этикеток</td></tr><tr class="success"><td>153</td><td>5</td><td style="border-top:none;white-space:pre">		this.labelLayer = this.template.layers.add();</td></tr><tr ><td>154</td><td></td><td style="border-top:none;white-space:pre">		// называем его именем label</td></tr><tr class="success"><td>155</td><td>5</td><td style="border-top:none;white-space:pre">		this.labelLayer.name = 'label';</td></tr><tr ><td>156</td><td></td><td style="border-top:none;white-space:pre">		// и помещаем его в самый низ в пачке слоев документа</td></tr><tr class="success"><td>157</td><td>5</td><td style="border-top:none;white-space:pre">		this.labelLayer.zOrder(ZOrderMethod.SENDTOBACK);</td></tr><tr class="success"><td>158</td><td>5</td><td style="border-top:none;white-space:pre">		return this.template.layers['label'];</td></tr><tr ><td>159</td><td></td><td style="border-top:none;white-space:pre">	},</td></tr><tr ><td>160</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>161</td><td></td><td style="border-top:none;white-space:pre">	/**</td></tr><tr ><td>162</td><td></td><td style="border-top:none;white-space:pre">	 * Нахождение левого нижнего контура высечки. Относительно него будет размещаться этикетки</td></tr><tr ><td>163</td><td></td><td style="border-top:none;white-space:pre">	 *</td></tr><tr ><td>164</td><td></td><td style="border-top:none;white-space:pre">	 * @return {PathItem} Левый нижний элемент со слоя 'cut'</td></tr><tr ><td>165</td><td></td><td style="border-top:none;white-space:pre">	 */</td></tr><tr ><td>166</td><td></td><td style="border-top:none;white-space:pre">	getLowerCut: function() {</td></tr><tr ><td>167</td><td></td><td style="border-top:none;white-space:pre">		// Создаем ссылку на массив высечек</td></tr><tr class="success"><td>168</td><td>5</td><td style="border-top:none;white-space:pre">		var cuts = this.template.layers['cut'].pathItems; </td></tr><tr ><td>169</td><td></td><td style="border-top:none;white-space:pre">		// Cоздаем массив, в котором сохраняем сумму X и Y-позиций всех элементов массива высечек.</td></tr><tr class="success"><td>170</td><td>5</td><td style="border-top:none;white-space:pre">		var sumXY = new Array (cuts.length);</td></tr><tr class="success"><td>171</td><td>5</td><td style="border-top:none;white-space:pre">		for (var i=0, l=cuts.length; i < l; i++) {</td></tr><tr class="success"><td>172</td><td>90</td><td style="border-top:none;white-space:pre">			var xPos = cuts[i].position[0];</td></tr><tr class="success"><td>173</td><td>90</td><td style="border-top:none;white-space:pre">			var yPos = cuts[i].position[1];</td></tr><tr class="success"><td>174</td><td>90</td><td style="border-top:none;white-space:pre">			sumXY[i] = xPos+yPos;</td></tr><tr ><td>175</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr ><td>176</td><td></td><td style="border-top:none;white-space:pre">		// Находим индекс мин. значения массива</td></tr><tr class="success"><td>177</td><td>5</td><td style="border-top:none;white-space:pre">		var target_index = 0; </td></tr><tr class="success"><td>178</td><td>5</td><td style="border-top:none;white-space:pre">		var target_sum = sumXY[0];</td></tr><tr ><td>179</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>180</td><td>5</td><td style="border-top:none;white-space:pre">		for (var it=0, lt=sumXY.length; it < lt; it++) {</td></tr><tr class="success"><td>181</td><td>90</td><td style="border-top:none;white-space:pre">			if (sumXY[it] <= target_sum) {</td></tr><tr class="success"><td>182</td><td>65</td><td style="border-top:none;white-space:pre">				target_index = it;</td></tr><tr class="success"><td>183</td><td>65</td><td style="border-top:none;white-space:pre">				target_sum = sumXY[it];</td></tr><tr ><td>184</td><td></td><td style="border-top:none;white-space:pre">			}</td></tr><tr ><td>185</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr ><td>186</td><td></td><td style="border-top:none;white-space:pre">		// Определяем целевой контур</td></tr><tr class="success"><td>187</td><td>5</td><td style="border-top:none;white-space:pre">		this.targetCut = cuts[target_index];</td></tr><tr class="success"><td>188</td><td>5</td><td style="border-top:none;white-space:pre">		return this.targetCut;</td></tr><tr ><td>189</td><td></td><td style="border-top:none;white-space:pre">	},</td></tr><tr ><td>190</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>191</td><td></td><td style="border-top:none;white-space:pre">	/**</td></tr><tr ><td>192</td><td></td><td style="border-top:none;white-space:pre">	 * Получение массива этикеток в задании</td></tr><tr ><td>193</td><td></td><td style="border-top:none;white-space:pre">	 *</td></tr><tr ><td>194</td><td></td><td style="border-top:none;white-space:pre">	 * @return {array} Массив объектов File</td></tr><tr ><td>195</td><td></td><td style="border-top:none;white-space:pre">	 */</td></tr><tr ><td>196</td><td></td><td style="border-top:none;white-space:pre">	getLabels: function() {</td></tr><tr ><td>197</td><td></td><td style="border-top:none;white-space:pre">		// Инициализация экземплярной переменной для хранения этикеток</td></tr><tr class="success"><td>198</td><td>4</td><td style="border-top:none;white-space:pre">		this.labels = []; </td></tr><tr class="success"><td>199</td><td>4</td><td style="border-top:none;white-space:pre">		for (var i=0, prl = this.printList.length; i < prl; i++) {</td></tr><tr ><td>200</td><td></td><td style="border-top:none;white-space:pre">			// Создаем ссылку на файл этикетки</td></tr><tr class="success"><td>201</td><td>8</td><td style="border-top:none;white-space:pre">			var labelObjectFile = new File (this.printList[i]);</td></tr><tr ><td>202</td><td></td><td style="border-top:none;white-space:pre">			// Сохраняем ссылку на файл в экземплярной переменной</td></tr><tr class="success"><td>203</td><td>8</td><td style="border-top:none;white-space:pre">			this.labels.push(labelObjectFile);</td></tr><tr ><td>204</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr class="success"><td>205</td><td>4</td><td style="border-top:none;white-space:pre">		return this.labels;</td></tr><tr ><td>206</td><td></td><td style="border-top:none;white-space:pre">	},</td></tr><tr ><td>207</td><td></td><td style="border-top:none;white-space:pre">	</td></tr><tr ><td>208</td><td></td><td style="border-top:none;white-space:pre">	/**</td></tr><tr ><td>209</td><td></td><td style="border-top:none;white-space:pre">	 * В некоторых ситуациях сборку делать не нужно. К примеру, если </td></tr><tr ><td>210</td><td></td><td style="border-top:none;white-space:pre">	 * этикетка всего одна, то сборки "Утверждение" и "Внимание" должны</td></tr><tr ><td>211</td><td></td><td style="border-top:none;white-space:pre">	 * игнорироваться.</td></tr><tr ><td>212</td><td></td><td style="border-top:none;white-space:pre">	 * В этом методе может быть переопределена логика такой ситуации.</td></tr><tr ><td>213</td><td></td><td style="border-top:none;white-space:pre">	 *</td></tr><tr ><td>214</td><td></td><td style="border-top:none;white-space:pre">	 * @return {boolean}</td></tr><tr ><td>215</td><td></td><td style="border-top:none;white-space:pre">	 */</td></tr><tr ><td>216</td><td></td><td style="border-top:none;white-space:pre">	isNeed: function() {</td></tr><tr class="success"><td>217</td><td>2</td><td style="border-top:none;white-space:pre">		if (this.labels.length < 2) {</td></tr><tr class="success"><td>218</td><td>1</td><td style="border-top:none;white-space:pre">			return false;</td></tr><tr ><td>219</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr class="success"><td>220</td><td>1</td><td style="border-top:none;white-space:pre">		return true;</td></tr><tr ><td>221</td><td></td><td style="border-top:none;white-space:pre">	},</td></tr><tr ><td>222</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>223</td><td></td><td style="border-top:none;white-space:pre">	/**</td></tr><tr ><td>224</td><td></td><td style="border-top:none;white-space:pre">	 * Выбор намотки. </td></tr><tr ><td>225</td><td></td><td style="border-top:none;white-space:pre">	 *</td></tr><tr ><td>226</td><td></td><td style="border-top:none;white-space:pre">	 * @return {GraphicStyle} </td></tr><tr ><td>227</td><td></td><td style="border-top:none;white-space:pre">	 */</td></tr><tr ><td>228</td><td></td><td style="border-top:none;white-space:pre">	getStyle: function() {</td></tr><tr ><td>229</td><td></td><td style="border-top:none;white-space:pre">		// Считываем массив намоток (графических стилей) документа</td></tr><tr class="success"><td>230</td><td>4</td><td style="border-top:none;white-space:pre">		var myRolls = this.template.graphicStyles;</td></tr><tr ><td>231</td><td></td><td style="border-top:none;white-space:pre">		// Намотка по умолчанию - 2</td></tr><tr class="success"><td>232</td><td>4</td><td style="border-top:none;white-space:pre">		var myStyle = 'roll_2_5';</td></tr><tr class="success"><td>233</td><td>4</td><td style="border-top:none;white-space:pre">		switch(this.roll_number) {</td></tr><tr ><td>234</td><td></td><td style="border-top:none;white-space:pre">			case "0":</td></tr><tr class="success"><td>235</td><td>4</td><td style="border-top:none;white-space:pre">				if (this.transform()) {</td></tr><tr class="success"><td>236</td><td>4</td><td style="border-top:none;white-space:pre">					myStyle=myRolls['roll_1_6']; // Крутить</td></tr><tr ><td>237</td><td></td><td style="border-top:none;white-space:pre">				} else {</td></tr><tr class="danger"><td>238</td><td>0</td><td style="border-top:none;white-space:pre">					myStyle=myRolls['roll_4_8']; // Не крутить</td></tr><tr ><td>239</td><td></td><td style="border-top:none;white-space:pre">				}</td></tr><tr class="success"><td>240</td><td>4</td><td style="border-top:none;white-space:pre">				break;</td></tr><tr ><td>241</td><td></td><td style="border-top:none;white-space:pre">			case "1":</td></tr><tr class="danger"><td>242</td><td>0</td><td style="border-top:none;white-space:pre">				myStyle=myRolls['roll_1_6'];</td></tr><tr class="danger"><td>243</td><td>0</td><td style="border-top:none;white-space:pre">					break;</td></tr><tr ><td>244</td><td></td><td style="border-top:none;white-space:pre">			case "2":</td></tr><tr class="danger"><td>245</td><td>0</td><td style="border-top:none;white-space:pre">				myStyle=myRolls['roll_2_5'];</td></tr><tr class="danger"><td>246</td><td>0</td><td style="border-top:none;white-space:pre">					break;</td></tr><tr ><td>247</td><td></td><td style="border-top:none;white-space:pre">			case "3":</td></tr><tr class="danger"><td>248</td><td>0</td><td style="border-top:none;white-space:pre">				myStyle=myRolls['roll_3_7'];</td></tr><tr class="danger"><td>249</td><td>0</td><td style="border-top:none;white-space:pre">					break;</td></tr><tr ><td>250</td><td></td><td style="border-top:none;white-space:pre">			case "4":</td></tr><tr class="danger"><td>251</td><td>0</td><td style="border-top:none;white-space:pre">				myStyle=myRolls['roll_4_8'];</td></tr><tr class="danger"><td>252</td><td>0</td><td style="border-top:none;white-space:pre">					break;</td></tr><tr ><td>253</td><td></td><td style="border-top:none;white-space:pre">			case "5":</td></tr><tr class="danger"><td>254</td><td>0</td><td style="border-top:none;white-space:pre">				myStyle=myRolls['roll_2_5'];</td></tr><tr class="danger"><td>255</td><td>0</td><td style="border-top:none;white-space:pre">					break;</td></tr><tr ><td>256</td><td></td><td style="border-top:none;white-space:pre">			case "6":</td></tr><tr class="danger"><td>257</td><td>0</td><td style="border-top:none;white-space:pre">				myStyle=myRolls['roll_1_6'];</td></tr><tr class="danger"><td>258</td><td>0</td><td style="border-top:none;white-space:pre">					break;</td></tr><tr ><td>259</td><td></td><td style="border-top:none;white-space:pre">			case "7":</td></tr><tr class="danger"><td>260</td><td>0</td><td style="border-top:none;white-space:pre">				myStyle=myRolls['roll_3_7'];</td></tr><tr class="danger"><td>261</td><td>0</td><td style="border-top:none;white-space:pre">					break;</td></tr><tr ><td>262</td><td></td><td style="border-top:none;white-space:pre">			case "8":</td></tr><tr class="danger"><td>263</td><td>0</td><td style="border-top:none;white-space:pre">				myStyle=myRolls['roll_4_8'];</td></tr><tr class="danger"><td>264</td><td>0</td><td style="border-top:none;white-space:pre">					break;</td></tr><tr ><td>265</td><td></td><td style="border-top:none;white-space:pre">			default:</td></tr><tr ><td>266</td><td></td><td style="border-top:none;white-space:pre">				//todo Throw exception here</td></tr><tr ><td>267</td><td></td><td style="border-top:none;white-space:pre">				//alert ('No such roll: ' + this.roll_number);</td></tr><tr class="danger"><td>268</td><td>0</td><td style="border-top:none;white-space:pre">				break;</td></tr><tr ><td>269</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr class="success"><td>270</td><td>4</td><td style="border-top:none;white-space:pre">		return myStyle;</td></tr><tr ><td>271</td><td></td><td style="border-top:none;white-space:pre">	},</td></tr><tr ><td>272</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>273</td><td></td><td style="border-top:none;white-space:pre">	/**</td></tr><tr ><td>274</td><td></td><td style="border-top:none;white-space:pre">	 * Логика определения намотки;</td></tr><tr ><td>275</td><td></td><td style="border-top:none;white-space:pre">	 * Вызывается из getStyle.switch...</td></tr><tr ><td>276</td><td></td><td style="border-top:none;white-space:pre">	 * </td></tr><tr ><td>277</td><td></td><td style="border-top:none;white-space:pre">	 * @return {boolean}</td></tr><tr ><td>278</td><td></td><td style="border-top:none;white-space:pre">	 */</td></tr><tr ><td>279</td><td></td><td style="border-top:none;white-space:pre">	transform: function() {</td></tr><tr ><td>280</td><td></td><td style="border-top:none;white-space:pre">		// Ручная намотка</td></tr><tr ><td>281</td><td></td><td style="border-top:none;white-space:pre">		// ПРЯМОУГОЛЬНАЯ / ОВАЛЬНАЯ ЭТИКЕТКА</td></tr><tr ><td>282</td><td></td><td style="border-top:none;white-space:pre">		// 1 - квадрат, крутить не надо;</td></tr><tr ><td>283</td><td></td><td style="border-top:none;white-space:pre">		// 0.999 ширина меньше высоты, крутим на -90 градусов</td></tr><tr ><td>284</td><td></td><td style="border-top:none;white-space:pre">		// 1.999 ширина больше высоты, крутить не надо</td></tr><tr class="success"><td>285</td><td>4</td><td style="border-top:none;white-space:pre">		var targetCutRate = this.targetCut.width / this.targetCut.height;</td></tr><tr class="success"><td>286</td><td>4</td><td style="border-top:none;white-space:pre">		var labelRate = this.currentLabel.width / this.currentLabel.height;</td></tr><tr class="success"><td>287</td><td>4</td><td style="border-top:none;white-space:pre">		return (((targetCutRate < 1) && (labelRate > 1)) || ((targetCutRate > 1) && (labelRate < 1)));</td></tr><tr ><td>288</td><td></td><td style="border-top:none;white-space:pre">	},</td></tr><tr ><td>289</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>290</td><td></td><td style="border-top:none;white-space:pre">	/**</td></tr><tr ><td>291</td><td></td><td style="border-top:none;white-space:pre">	 * Поместить и позиционировать этикетку на слой labels</td></tr><tr ><td>292</td><td></td><td style="border-top:none;white-space:pre">	 * </td></tr><tr ><td>293</td><td></td><td style="border-top:none;white-space:pre">	 * @param {PathItem} origin Элемент спуска, относительно которого помещать этикетку;</td></tr><tr ><td>294</td><td></td><td style="border-top:none;white-space:pre">	 * @param {File} file Объект File, который необходимо поместить;</td></tr><tr ><td>295</td><td></td><td style="border-top:none;white-space:pre">	 * @return {void}</td></tr><tr ><td>296</td><td></td><td style="border-top:none;white-space:pre">	 */ </td></tr><tr ><td>297</td><td></td><td style="border-top:none;white-space:pre">	placeLabel: function(origin, file) {</td></tr><tr ><td>298</td><td></td><td style="border-top:none;white-space:pre">		// Определяем ширину единичного контура высечки</td></tr><tr class="success"><td>299</td><td>4</td><td style="border-top:none;white-space:pre">		var LsizeX = this.targetCut.width; </td></tr><tr ><td>300</td><td></td><td style="border-top:none;white-space:pre">		// Определяем высоту единичного контура высечки</td></tr><tr class="success"><td>301</td><td>4</td><td style="border-top:none;white-space:pre">		var LsizeY = this.targetCut.height; </td></tr><tr ><td>302</td><td></td><td style="border-top:none;white-space:pre">		// Помещаем File на спуск и сохраняем ссылку на него в экземплярной переменной this.currentLabel</td></tr><tr class="success"><td>303</td><td>4</td><td style="border-top:none;white-space:pre">		this.currentLabel = this.labelLayer.placedItems.add();</td></tr><tr class="success"><td>304</td><td>4</td><td style="border-top:none;white-space:pre">		var cl = this.currentLabel;</td></tr><tr class="success"><td>305</td><td>4</td><td style="border-top:none;white-space:pre">		cl.file = file;</td></tr><tr ><td>306</td><td></td><td style="border-top:none;white-space:pre">		// Выравниваем этикетку по целевому контуру (параметр origin)</td></tr><tr class="success"><td>307</td><td>4</td><td style="border-top:none;white-space:pre">		var clX = origin.position[0]+(LsizeX/2) - (cl.width/2);</td></tr><tr class="success"><td>308</td><td>4</td><td style="border-top:none;white-space:pre">		var clY = origin.position[1]-(LsizeY/2) + (cl.height/2);</td></tr><tr class="success"><td>309</td><td>4</td><td style="border-top:none;white-space:pre">		cl.position = new Array (clX, clY); </td></tr><tr ><td>310</td><td></td><td style="border-top:none;white-space:pre">	},</td></tr><tr ><td>311</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>312</td><td></td><td style="border-top:none;white-space:pre">	/**</td></tr><tr ><td>313</td><td></td><td style="border-top:none;white-space:pre">	 * Применение графического стиля к ТЕКУЩЕЙ этикетке. </td></tr><tr ><td>314</td><td></td><td style="border-top:none;white-space:pre">	 * "Текущая эткетка" - это this.currentLabel</td></tr><tr ><td>315</td><td></td><td style="border-top:none;white-space:pre">	 *</td></tr><tr ><td>316</td><td></td><td style="border-top:none;white-space:pre">	 * @return {void}</td></tr><tr ><td>317</td><td></td><td style="border-top:none;white-space:pre">	 */</td></tr><tr ><td>318</td><td></td><td style="border-top:none;white-space:pre">	applyStyle: function() {</td></tr><tr class="success"><td>319</td><td>4</td><td style="border-top:none;white-space:pre">		var myStyle = this.getStyle();</td></tr><tr ><td>320</td><td></td><td style="border-top:none;white-space:pre">		// Применям графический стиль к этикетке</td></tr><tr class="success"><td>321</td><td>4</td><td style="border-top:none;white-space:pre">		myStyle.applyTo(this.currentLabel); </td></tr><tr ><td>322</td><td></td><td style="border-top:none;white-space:pre">	},</td></tr><tr ><td>323</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>324</td><td></td><td style="border-top:none;white-space:pre">	/**</td></tr><tr ><td>325</td><td></td><td style="border-top:none;white-space:pre">	 * Генерация имени файла для экспорта в PDF</td></tr><tr ><td>326</td><td></td><td style="border-top:none;white-space:pre">	 *</td></tr><tr ><td>327</td><td></td><td style="border-top:none;white-space:pre">	 * @param {number} index Иногда нужен, когда этикеток в задании много и необходима нумерация файлов</td></tr><tr ><td>328</td><td></td><td style="border-top:none;white-space:pre">	 * @return {string} Имя PDF сборки</td></tr><tr ><td>329</td><td></td><td style="border-top:none;white-space:pre">	 */</td></tr><tr ><td>330</td><td></td><td style="border-top:none;white-space:pre">	getPDFName: function(index) {</td></tr><tr class="success"><td>331</td><td>4</td><td style="border-top:none;white-space:pre">		if (this.currentLabel instanceof File) {</td></tr><tr class="success"><td>332</td><td>1</td><td style="border-top:none;white-space:pre">			this.child = this.currentLabel.parent;</td></tr><tr ><td>333</td><td></td><td style="border-top:none;white-space:pre">		} else {</td></tr><tr class="success"><td>334</td><td>3</td><td style="border-top:none;white-space:pre">			this.child = this.currentLabel.file.parent;</td></tr><tr ><td>335</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr ><td>336</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>337</td><td>4</td><td style="border-top:none;white-space:pre">		this.setNameRange();</td></tr><tr ><td>338</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>339</td><td></td><td style="border-top:none;white-space:pre">		// Common Name prefix</td></tr><tr class="success"><td>340</td><td>4</td><td style="border-top:none;white-space:pre">		var cName = this.child.parent.parent.name + this.child.parent.name;</td></tr><tr ><td>341</td><td></td><td style="border-top:none;white-space:pre">		// Имя файла сборки</td></tr><tr class="success"><td>342</td><td>4</td><td style="border-top:none;white-space:pre">		return this.getPDFPart(index, this.range, cName);</td></tr><tr ><td>343</td><td></td><td style="border-top:none;white-space:pre">	},</td></tr><tr ><td>344</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>345</td><td></td><td style="border-top:none;white-space:pre">	/**</td></tr><tr ><td>346</td><td></td><td style="border-top:none;white-space:pre">	 * Определение диапазона папок</td></tr><tr ><td>347</td><td></td><td style="border-top:none;white-space:pre">	 *</td></tr><tr ><td>348</td><td></td><td style="border-top:none;white-space:pre">	 * @return {string} range</td></tr><tr ><td>349</td><td></td><td style="border-top:none;white-space:pre">	 */ </td></tr><tr ><td>350</td><td></td><td style="border-top:none;white-space:pre">	setNameRange: function() {</td></tr><tr class="success"><td>351</td><td>7</td><td style="border-top:none;white-space:pre">		var targetName = [];</td></tr><tr class="success"><td>352</td><td>7</td><td style="border-top:none;white-space:pre">		for (var i=0, l=this.labels.length; i < l; i++) {</td></tr><tr class="success"><td>353</td><td>14</td><td style="border-top:none;white-space:pre">			targetName[i]= this.labels[i].parent.name;</td></tr><tr ><td>354</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr ><td>355</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>356</td><td>7</td><td style="border-top:none;white-space:pre">		if (targetName.length === 1) {</td></tr><tr class="success"><td>357</td><td>1</td><td style="border-top:none;white-space:pre">			this.range = targetName[0];</td></tr><tr ><td>358</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>359</td><td></td><td style="border-top:none;white-space:pre">			// Если массив из одного значения, то this.range равен ему.</td></tr><tr ><td>360</td><td></td><td style="border-top:none;white-space:pre">			// в противном случае, мы проверяем на уникальность все элементы массива</td></tr><tr ><td>361</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>362</td><td></td><td style="border-top:none;white-space:pre">		} else {</td></tr><tr ><td>363</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>364</td><td>6</td><td style="border-top:none;white-space:pre">			targetName.sort();</td></tr><tr class="success"><td>365</td><td>6</td><td style="border-top:none;white-space:pre">			var unique;</td></tr><tr ><td>366</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>367</td><td></td><td style="border-top:none;white-space:pre">			// @@todo Глаз режут объявления i и l без var, будто бы в global гадим.</td></tr><tr ><td>368</td><td></td><td style="border-top:none;white-space:pre">			// Может, другие имена использовать, чисто для красоты?</td></tr><tr class="success"><td>369</td><td>6</td><td style="border-top:none;white-space:pre">			for (i=1, l=targetName.length; i < l; i++) {</td></tr><tr class="success"><td>370</td><td>7</td><td style="border-top:none;white-space:pre">				if (targetName[0] === targetName[i]) {</td></tr><tr class="success"><td>371</td><td>1</td><td style="border-top:none;white-space:pre">					unique = 0;			</td></tr><tr ><td>372</td><td></td><td style="border-top:none;white-space:pre">				} else {</td></tr><tr class="success"><td>373</td><td>6</td><td style="border-top:none;white-space:pre">					unique = 1;</td></tr><tr ><td>374</td><td></td><td style="border-top:none;white-space:pre">				}		</td></tr><tr ><td>375</td><td></td><td style="border-top:none;white-space:pre">			}</td></tr><tr ><td>376</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>377</td><td>6</td><td style="border-top:none;white-space:pre">			if (unique < 1) {</td></tr><tr class="danger"><td>378</td><td>0</td><td style="border-top:none;white-space:pre">				this.range = targetName[0];</td></tr><tr ><td>379</td><td></td><td style="border-top:none;white-space:pre">				// если уникальность равна нулю, значит элементы  targetName одинаковые</td></tr><tr ><td>380</td><td></td><td style="border-top:none;white-space:pre">				// и range будет представлен одним числом,</td></tr><tr ><td>381</td><td></td><td style="border-top:none;white-space:pre">				// в противном случае, элементы  targetName - разные, тогда range будет составной.</td></tr><tr ><td>382</td><td></td><td style="border-top:none;white-space:pre">			} else {</td></tr><tr class="success"><td>383</td><td>6</td><td style="border-top:none;white-space:pre">				this.range = targetName[0] + '_' + targetName[targetName.length-1];			</td></tr><tr ><td>384</td><td></td><td style="border-top:none;white-space:pre">			}</td></tr><tr ><td>385</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr class="success"><td>386</td><td>7</td><td style="border-top:none;white-space:pre">		return this.range;</td></tr><tr ><td>387</td><td></td><td style="border-top:none;white-space:pre">	},</td></tr><tr ><td>388</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>389</td><td></td><td style="border-top:none;white-space:pre">	/**</td></tr><tr ><td>390</td><td></td><td style="border-top:none;white-space:pre">	 * Экспорт сборки в формате PDF</td></tr><tr ><td>391</td><td></td><td style="border-top:none;white-space:pre">	 *</td></tr><tr ><td>392</td><td></td><td style="border-top:none;white-space:pre">	 * @param {string} fileName Имя файла для экспорта</td></tr><tr ><td>393</td><td></td><td style="border-top:none;white-space:pre">	 * @throws {customException} IO error</td></tr><tr ><td>394</td><td></td><td style="border-top:none;white-space:pre">	 * @return {void}</td></tr><tr ><td>395</td><td></td><td style="border-top:none;white-space:pre">	 */</td></tr><tr ><td>396</td><td></td><td style="border-top:none;white-space:pre">	exportPDF: function(fileName) {</td></tr><tr class="success"><td>397</td><td>5</td><td style="border-top:none;white-space:pre">		this.ResultFilePDF = new File(fileName);</td></tr><tr class="success"><td>398</td><td>5</td><td style="border-top:none;white-space:pre">		try {</td></tr><tr class="success"><td>399</td><td>5</td><td style="border-top:none;white-space:pre">			this.template.saveAs(this.ResultFilePDF, this.PDFSettings);</td></tr><tr ><td>400</td><td></td><td style="border-top:none;white-space:pre">		} catch (e) {</td></tr><tr class="success"><td>401</td><td>1</td><td style="border-top:none;white-space:pre">			throw {</td></tr><tr ><td>402</td><td></td><td style="border-top:none;white-space:pre">				message: e.message,</td></tr><tr ><td>403</td><td></td><td style="border-top:none;white-space:pre">				file: fileName,</td></tr><tr ><td>404</td><td></td><td style="border-top:none;white-space:pre">			};</td></tr><tr ><td>405</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr ><td>406</td><td></td><td style="border-top:none;white-space:pre">	},</td></tr><tr ><td>407</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>408</td><td></td><td style="border-top:none;white-space:pre">	/**</td></tr><tr ><td>409</td><td></td><td style="border-top:none;white-space:pre">	 * Копирование готового файла сборки в "горячую" папку растрового процессора</td></tr><tr ><td>410</td><td></td><td style="border-top:none;white-space:pre">	 *</td></tr><tr ><td>411</td><td></td><td style="border-top:none;white-space:pre">	 * @throws {customException} IO error</td></tr><tr ><td>412</td><td></td><td style="border-top:none;white-space:pre">	 * @return {void}</td></tr><tr ><td>413</td><td></td><td style="border-top:none;white-space:pre">	 */</td></tr><tr ><td>414</td><td></td><td style="border-top:none;white-space:pre">	sendtoHotFolder: function() {</td></tr><tr class="success"><td>415</td><td>5</td><td style="border-top:none;white-space:pre">		var success = this.ResultFilePDF.copy(this.hotFolder + '\\' + this.ResultFilePDF.name);</td></tr><tr class="success"><td>416</td><td>5</td><td style="border-top:none;white-space:pre">		if (!success) {</td></tr><tr class="success"><td>417</td><td>1</td><td style="border-top:none;white-space:pre">			throw {</td></tr><tr ><td>418</td><td></td><td style="border-top:none;white-space:pre">				message: 'Copy to hotfolder failed', </td></tr><tr ><td>419</td><td></td><td style="border-top:none;white-space:pre">				file: this.ResultFilePDF.name,</td></tr><tr ><td>420</td><td></td><td style="border-top:none;white-space:pre">			};</td></tr><tr ><td>421</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr ><td>422</td><td></td><td style="border-top:none;white-space:pre">	},</td></tr><tr ><td>423</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>424</td><td></td><td style="border-top:none;white-space:pre">	/**</td></tr><tr ><td>425</td><td></td><td style="border-top:none;white-space:pre">	 * Закрытие активного документа без сохранения</td></tr><tr ><td>426</td><td></td><td style="border-top:none;white-space:pre">	 * @return {void}</td></tr><tr ><td>427</td><td></td><td style="border-top:none;white-space:pre">	 */</td></tr><tr ><td>428</td><td></td><td style="border-top:none;white-space:pre">	closeTemplate: function() {</td></tr><tr class="success"><td>429</td><td>3</td><td style="border-top:none;white-space:pre">		this.template.close(SaveOptions.DONOTSAVECHANGES);</td></tr><tr ><td>430</td><td></td><td style="border-top:none;white-space:pre">	},</td></tr><tr ><td>431</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>432</td><td></td><td style="border-top:none;white-space:pre">	/**</td></tr><tr ><td>433</td><td></td><td style="border-top:none;white-space:pre">	 * Интерфейс к мессенджеру</td></tr><tr ><td>434</td><td></td><td style="border-top:none;white-space:pre">	 *</td></tr><tr ><td>435</td><td></td><td style="border-top:none;white-space:pre">	 * @param {string} status</td></tr><tr ><td>436</td><td></td><td style="border-top:none;white-space:pre">	 * @param {object} message</td></tr><tr ><td>437</td><td></td><td style="border-top:none;white-space:pre">	 * @return {boolean} sended</td></tr><tr ><td>438</td><td></td><td style="border-top:none;white-space:pre">	 */</td></tr><tr ><td>439</td><td></td><td style="border-top:none;white-space:pre">	send: function(status, message) {</td></tr><tr class="danger"><td>440</td><td>0</td><td style="border-top:none;white-space:pre">		var sended, type, parcel;</td></tr><tr ><td>441</td><td></td><td style="border-top:none;white-space:pre">		// Присутствие мессенджера не обязательно:</td></tr><tr class="danger"><td>442</td><td>0</td><td style="border-top:none;white-space:pre">		if ((typeof(this.messenger) !== 'undefined') && typeof(this.messenger.send) === 'function') {</td></tr><tr ><td>443</td><td></td><td style="border-top:none;white-space:pre">			// Если первый параметр опущен (точнее, первым идёт message):</td></tr><tr class="danger"><td>444</td><td>0</td><td style="border-top:none;white-space:pre">			if (typeof(message) === 'undefined') {</td></tr><tr class="danger"><td>445</td><td>0</td><td style="border-top:none;white-space:pre">				type = null;</td></tr><tr class="danger"><td>446</td><td>0</td><td style="border-top:none;white-space:pre">				parcel = status;</td></tr><tr ><td>447</td><td></td><td style="border-top:none;white-space:pre">			} else {</td></tr><tr class="danger"><td>448</td><td>0</td><td style="border-top:none;white-space:pre">				type = status;</td></tr><tr class="danger"><td>449</td><td>0</td><td style="border-top:none;white-space:pre">				parcel = message;</td></tr><tr ><td>450</td><td></td><td style="border-top:none;white-space:pre">			}</td></tr><tr ><td>451</td><td></td><td style="border-top:none;white-space:pre">			// Обязаловка:</td></tr><tr ><td>452</td><td></td><td style="border-top:none;white-space:pre">			// _id : required,</td></tr><tr ><td>453</td><td></td><td style="border-top:none;white-space:pre">			// result: {data: required}</td></tr><tr class="danger"><td>454</td><td>0</td><td style="border-top:none;white-space:pre">			var wrapper = {</td></tr><tr ><td>455</td><td></td><td style="border-top:none;white-space:pre">				jobid : this.job._id,</td></tr><tr ><td>456</td><td></td><td style="border-top:none;white-space:pre">				result: { data: parcel },</td></tr><tr ><td>457</td><td></td><td style="border-top:none;white-space:pre">			};</td></tr><tr class="danger"><td>458</td><td>0</td><td style="border-top:none;white-space:pre">			this.messenger.send(type, wrapper);</td></tr><tr ><td>459</td><td></td><td style="border-top:none;white-space:pre">		} else {</td></tr><tr class="danger"><td>460</td><td>0</td><td style="border-top:none;white-space:pre">			sended = false;</td></tr><tr ><td>461</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr class="danger"><td>462</td><td>0</td><td style="border-top:none;white-space:pre">		return sended;</td></tr><tr ><td>463</td><td></td><td style="border-top:none;white-space:pre">	},</td></tr><tr ><td>464</td><td></td><td style="border-top:none;white-space:pre">	</td></tr><tr ><td>465</td><td></td><td style="border-top:none;white-space:pre">	/**</td></tr><tr ><td>466</td><td></td><td style="border-top:none;white-space:pre">	 * Логика выполнения сборок. </td></tr><tr ><td>467</td><td></td><td style="border-top:none;white-space:pre">	 * Паттерн "Шаблонный метод"</td></tr><tr ><td>468</td><td></td><td style="border-top:none;white-space:pre">	 */</td></tr><tr ><td>469</td><td></td><td style="border-top:none;white-space:pre">	run: function() {</td></tr><tr class="success"><td>470</td><td>3</td><td style="border-top:none;white-space:pre">		this.getLabels();</td></tr><tr class="success"><td>471</td><td>3</td><td style="border-top:none;white-space:pre">		if (this.isNeed) {</td></tr><tr class="success"><td>472</td><td>3</td><td style="border-top:none;white-space:pre">			this.openTemplate();</td></tr><tr class="success"><td>473</td><td>3</td><td style="border-top:none;white-space:pre">			this.setLabelLayer();</td></tr><tr class="success"><td>474</td><td>3</td><td style="border-top:none;white-space:pre">			this.getLowerCut();</td></tr><tr class="success"><td>475</td><td>3</td><td style="border-top:none;white-space:pre">			this.imposeLabels();</td></tr><tr class="success"><td>476</td><td>3</td><td style="border-top:none;white-space:pre">			this.closeTemplate();</td></tr><tr ><td>477</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr ><td>478</td><td></td><td style="border-top:none;white-space:pre">	},</td></tr><tr ><td>479</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>480</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>481</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>482</td><td></td><td style="border-top:none;white-space:pre"> * @classdesc Размещение этикеток на спуске</td></tr><tr ><td>483</td><td></td><td style="border-top:none;white-space:pre"> * @constructor</td></tr><tr ><td>484</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>485</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.AssemblyImposer = function() {};</td></tr><tr class="success"><td>486</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.AssemblyImposer.prototype = new Indigo.BaseImposer(app);</td></tr><tr class="success"><td>487</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.AssemblyImposer.prototype.constructor = Indigo.AssemblyImposer;</td></tr><tr ><td>488</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>489</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.AssemblyImposer.prototype.currentLabel = null;</td></tr><tr ><td>490</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>491</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>492</td><td></td><td style="border-top:none;white-space:pre"> * Получение ссылки на файл шаблона</td></tr><tr ><td>493</td><td></td><td style="border-top:none;white-space:pre"> * @return {File} Файл шаблона</td></tr><tr ><td>494</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>495</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.AssemblyImposer.prototype.getTemplateName = function () {</td></tr><tr class="success"><td>496</td><td>4</td><td style="border-top:none;white-space:pre">	var template = new File (this.templateFolder + '\\' + this.temp + '.ai');</td></tr><tr class="success"><td>497</td><td>4</td><td style="border-top:none;white-space:pre">	return template;</td></tr><tr ><td>498</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>499</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>500</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>501</td><td></td><td style="border-top:none;white-space:pre"> * Этот класс сборки делается в любом случае</td></tr><tr ><td>502</td><td></td><td style="border-top:none;white-space:pre"> * @return {boolean}</td></tr><tr ><td>503</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>504</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.AssemblyImposer.prototype.isNeed = function() {</td></tr><tr class="success"><td>505</td><td>1</td><td style="border-top:none;white-space:pre">	return true;</td></tr><tr ><td>506</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>507</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>508</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>509</td><td></td><td style="border-top:none;white-space:pre"> * Размещение этикетки на листе</td></tr><tr ><td>510</td><td></td><td style="border-top:none;white-space:pre"> * (Применение графического стиля)</td></tr><tr ><td>511</td><td></td><td style="border-top:none;white-space:pre"> * </td></tr><tr ><td>512</td><td></td><td style="border-top:none;white-space:pre"> * @return {void}</td></tr><tr ><td>513</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>514</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.AssemblyImposer.prototype.imposeLabels = function() {</td></tr><tr class="success"><td>515</td><td>1</td><td style="border-top:none;white-space:pre">	var tc = this.targetCut;</td></tr><tr class="success"><td>516</td><td>1</td><td style="border-top:none;white-space:pre">	for (var i=0, l=this.labels.length; i < l; i++) {</td></tr><tr class="success"><td>517</td><td>2</td><td style="border-top:none;white-space:pre">		try {</td></tr><tr ><td>518</td><td></td><td style="border-top:none;white-space:pre">			// Помещаем на слой layer файл этикетки</td></tr><tr class="success"><td>519</td><td>2</td><td style="border-top:none;white-space:pre">			this.placeLabel(tc, this.labels[i]);</td></tr><tr ><td>520</td><td></td><td style="border-top:none;white-space:pre">			// Крутим</td></tr><tr class="success"><td>521</td><td>2</td><td style="border-top:none;white-space:pre">			this.applyStyle();</td></tr><tr class="success"><td>522</td><td>2</td><td style="border-top:none;white-space:pre">			this.exportPDF(this.getPDFName(i));</td></tr><tr class="success"><td>523</td><td>2</td><td style="border-top:none;white-space:pre">			this.sendtoHotFolder(); // Кидаем сборку в горячую папку</td></tr><tr class="success"><td>524</td><td>2</td><td style="border-top:none;white-space:pre">			this.currentLabel.remove();</td></tr><tr ><td>525</td><td></td><td style="border-top:none;white-space:pre">		} catch (err) {</td></tr><tr ><td>526</td><td></td><td style="border-top:none;white-space:pre">			// Continue flow</td></tr><tr class="danger"><td>527</td><td>0</td><td style="border-top:none;white-space:pre">			$.writeln('Continue.AssemblyImposer.v3');</td></tr><tr class="danger"><td>528</td><td>0</td><td style="border-top:none;white-space:pre">			var errobj = {</td></tr><tr ><td>529</td><td></td><td style="border-top:none;white-space:pre">				message: err.message,</td></tr><tr ><td>530</td><td></td><td style="border-top:none;white-space:pre">				source: 'AssemblyImposer',</td></tr><tr ><td>531</td><td></td><td style="border-top:none;white-space:pre">				file: this.labels[i].fullName,</td></tr><tr ><td>532</td><td></td><td style="border-top:none;white-space:pre">				severity: 'warning',</td></tr><tr ><td>533</td><td></td><td style="border-top:none;white-space:pre">				jobid: this.job.id,</td></tr><tr ><td>534</td><td></td><td style="border-top:none;white-space:pre">			};</td></tr><tr class="danger"><td>535</td><td>0</td><td style="border-top:none;white-space:pre">			this.job.errors.push(errobj);</td></tr><tr ><td>536</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr ><td>537</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr ><td>538</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>539</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>540</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>541</td><td></td><td style="border-top:none;white-space:pre"> * Возвращает имя файла для экспорта в PDF</td></tr><tr ><td>542</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>543</td><td></td><td style="border-top:none;white-space:pre"> * @param {number} index Номер файла</td></tr><tr ><td>544</td><td></td><td style="border-top:none;white-space:pre"> * @param {string} range Диапазон папок</td></tr><tr ><td>545</td><td></td><td style="border-top:none;white-space:pre"> * @param {string} cName Чё за хрень не помню</td></tr><tr ><td>546</td><td></td><td style="border-top:none;white-space:pre"> * @return {string} Имя файла</td></tr><tr ><td>547</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>548</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.AssemblyImposer.prototype.getPDFPart = function(index, range, cName) {</td></tr><tr class="success"><td>549</td><td>2</td><td style="border-top:none;white-space:pre">	return this.child + '\\' + cName + this.child.name + '_' + this.currentLabel.file.name.replace ('eps', 'pdf');</td></tr><tr ><td>550</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>551</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>552</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>553</td><td></td><td style="border-top:none;white-space:pre"> * @classdesc "Разбивает" разные задания в тираже привлекающей </td></tr><tr ><td>554</td><td></td><td style="border-top:none;white-space:pre"> * внимание надписью. Печатнику легче ориентироваться. Человеческий </td></tr><tr ><td>555</td><td></td><td style="border-top:none;white-space:pre"> * фактор нервно курит в сторонке.</td></tr><tr ><td>556</td><td></td><td style="border-top:none;white-space:pre"> * @constructor</td></tr><tr ><td>557</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>558</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.AchtungImposer = function() {};</td></tr><tr class="success"><td>559</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.AchtungImposer.prototype = new Indigo.BaseImposer(app);</td></tr><tr class="success"><td>560</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.AchtungImposer.prototype.constructor = Indigo.AchtungImposer;</td></tr><tr ><td>561</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>562</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>563</td><td></td><td style="border-top:none;white-space:pre"> * @prop {string} achtungLabel Путь к файлу "Внимание..."</td></tr><tr ><td>564</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>565</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.AchtungImposer.prototype.achtungLabel = Indigo.config.achtungFile;</td></tr><tr ><td>566</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>567</td><td></td><td style="border-top:none;white-space:pre">/** </td></tr><tr ><td>568</td><td></td><td style="border-top:none;white-space:pre"> * Размещение этикетки на листе.</td></tr><tr ><td>569</td><td></td><td style="border-top:none;white-space:pre"> * В данном случае this.labels идёт лесом, мы ставим единственный</td></tr><tr ><td>570</td><td></td><td style="border-top:none;white-space:pre"> * файл (ACHTUNG.eps) по центру печатного листа и масштабируем его</td></tr><tr ><td>571</td><td></td><td style="border-top:none;white-space:pre"> * до максимально возможного размера</td></tr><tr ><td>572</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>573</td><td></td><td style="border-top:none;white-space:pre"> * @return {void}</td></tr><tr ><td>574</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>575</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.AchtungImposer.prototype.imposeLabels = function() {</td></tr><tr ><td>576</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>577</td><td>1</td><td style="border-top:none;white-space:pre">	var template = this.template;</td></tr><tr ><td>578</td><td></td><td style="border-top:none;white-space:pre">	// Помещаем на слой layer файл ACHTUNG.eps</td></tr><tr class="success"><td>579</td><td>1</td><td style="border-top:none;white-space:pre">	var achtungPlace = this.labelLayer.placedItems.add();</td></tr><tr class="success"><td>580</td><td>1</td><td style="border-top:none;white-space:pre">	achtungPlace.file = new File (this.achtungLabel);</td></tr><tr ><td>581</td><td></td><td style="border-top:none;white-space:pre">	</td></tr><tr ><td>582</td><td></td><td style="border-top:none;white-space:pre">	// Выравниваем ахтунг по центру артбоарда</td></tr><tr class="success"><td>583</td><td>1</td><td style="border-top:none;white-space:pre">	var targetPlace = new Array (</td></tr><tr ><td>584</td><td></td><td style="border-top:none;white-space:pre">		(template.width / 2) - (achtungPlace.width / 2),</td></tr><tr ><td>585</td><td></td><td style="border-top:none;white-space:pre">		(template.height / 2) + (achtungPlace.height / 2)</td></tr><tr ><td>586</td><td></td><td style="border-top:none;white-space:pre">	);</td></tr><tr class="success"><td>587</td><td>1</td><td style="border-top:none;white-space:pre">	achtungPlace.position = targetPlace;</td></tr><tr ><td>588</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>589</td><td></td><td style="border-top:none;white-space:pre">	// Корректируем размеры ахтунга</td></tr><tr ><td>590</td><td></td><td style="border-top:none;white-space:pre">	// Предупреждение должно занимать почти весь лист, но с учётом меток</td></tr><tr ><td>591</td><td></td><td style="border-top:none;white-space:pre">	// Опытным путём получены такие пропорции: 99% от высоты листа, 88% от ширины его</td></tr><tr class="success"><td>592</td><td>1</td><td style="border-top:none;white-space:pre">	var HeightRatioPercent = 99;</td></tr><tr class="success"><td>593</td><td>1</td><td style="border-top:none;white-space:pre">	var WidthRatioPercent = 88;</td></tr><tr class="success"><td>594</td><td>1</td><td style="border-top:none;white-space:pre">	var width_percent = (template.width * WidthRatioPercent) / achtungPlace.width;</td></tr><tr class="success"><td>595</td><td>1</td><td style="border-top:none;white-space:pre">	var height_percent = (template.height * HeightRatioPercent) / achtungPlace.height;</td></tr><tr class="success"><td>596</td><td>1</td><td style="border-top:none;white-space:pre">	achtungPlace.resize (width_percent, height_percent);</td></tr><tr ><td>597</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>598</td><td></td><td style="border-top:none;white-space:pre">	// Здесь currentLabel необходим для того, чтобы Ахтунг упал </td></tr><tr ><td>599</td><td></td><td style="border-top:none;white-space:pre">	// в нужное место (туда, где лежит первая этикетка задания)</td></tr><tr class="success"><td>600</td><td>1</td><td style="border-top:none;white-space:pre">	this.currentLabel = this.labels[0];</td></tr><tr ><td>601</td><td></td><td style="border-top:none;white-space:pre">	</td></tr><tr ><td>602</td><td></td><td style="border-top:none;white-space:pre">	// Экспорт сборки на сервер</td></tr><tr class="success"><td>603</td><td>1</td><td style="border-top:none;white-space:pre">	this.exportPDF(this.getPDFName());</td></tr><tr ><td>604</td><td></td><td style="border-top:none;white-space:pre">	</td></tr><tr ><td>605</td><td></td><td style="border-top:none;white-space:pre">	// Экспорт сборки в горячую папку на RIP</td></tr><tr class="success"><td>606</td><td>1</td><td style="border-top:none;white-space:pre">	this.sendtoHotFolder();</td></tr><tr ><td>607</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>608</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>609</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>610</td><td></td><td style="border-top:none;white-space:pre"> * Возвращает имя файла для экспорта в PDF. </td></tr><tr ><td>611</td><td></td><td style="border-top:none;white-space:pre"> * Сборка должна падать в папку с первой этикеткой задания</td></tr><tr ><td>612</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>613</td><td></td><td style="border-top:none;white-space:pre"> * @param {number} index Номер файла</td></tr><tr ><td>614</td><td></td><td style="border-top:none;white-space:pre"> * @param {range} string Диапазон папок</td></tr><tr ><td>615</td><td></td><td style="border-top:none;white-space:pre"> * @param {string} cName Чё за хрень не помню</td></tr><tr ><td>616</td><td></td><td style="border-top:none;white-space:pre"> * @return {string}</td></tr><tr ><td>617</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>618</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.AchtungImposer.prototype.getPDFPart = function(index, range, cName) {</td></tr><tr class="success"><td>619</td><td>1</td><td style="border-top:none;white-space:pre">	return this.child + '\\' + cName + range + '_ACHTUNG.pdf';</td></tr><tr ><td>620</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>621</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>622</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>623</td><td></td><td style="border-top:none;white-space:pre"> * @classdesc Сборка "Утверждение".</td></tr><tr ><td>624</td><td></td><td style="border-top:none;white-space:pre"> * Размещение всех этикеток задания на одном печатном листе</td></tr><tr ><td>625</td><td></td><td style="border-top:none;white-space:pre"> * @constructor</td></tr><tr ><td>626</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>627</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.MatchingImposer = function() {};</td></tr><tr class="success"><td>628</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.MatchingImposer.prototype = new Indigo.BaseImposer(app);</td></tr><tr class="success"><td>629</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.MatchingImposer.prototype.constructor = Indigo.MatchingImposer;</td></tr><tr ><td>630</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>631</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.MatchingImposer.prototype.currentLabel = null;</td></tr><tr ><td>632</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>633</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>634</td><td></td><td style="border-top:none;white-space:pre"> * Размещение этикеток на листе. </td></tr><tr ><td>635</td><td></td><td style="border-top:none;white-space:pre"> * Если этикеток в задании больше, чем высекальных контуров в шаблоне, </td></tr><tr ><td>636</td><td></td><td style="border-top:none;white-space:pre"> * то необходимо создавать несколько сборок-утверждений. </td></tr><tr ><td>637</td><td></td><td style="border-top:none;white-space:pre"> * К примеру, если контуров 8, а этикеток 6 - создаётся одна сборка; </td></tr><tr ><td>638</td><td></td><td style="border-top:none;white-space:pre"> * Если контуров 8, а этикеток 12 - создаётся две сборки. </td></tr><tr ><td>639</td><td></td><td style="border-top:none;white-space:pre"> * В связи с этим сборки нумеруются по схеме UTV_1, UTV_2, и.т.д;</td></tr><tr ><td>640</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>641</td><td></td><td style="border-top:none;white-space:pre"> * @throws {customException} Нет файла этикетки</td></tr><tr ><td>642</td><td></td><td style="border-top:none;white-space:pre"> * @return {void}</td></tr><tr ><td>643</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>644</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.MatchingImposer.prototype.imposeLabels = function() {</td></tr><tr ><td>645</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>646</td><td>1</td><td style="border-top:none;white-space:pre">	var cuts = this.template.layers['cut'].pathItems;</td></tr><tr class="success"><td>647</td><td>1</td><td style="border-top:none;white-space:pre">	var cutsCount = cuts.length;</td></tr><tr class="success"><td>648</td><td>1</td><td style="border-top:none;white-space:pre">	var labelsCount = this.labels.length;</td></tr><tr class="success"><td>649</td><td>1</td><td style="border-top:none;white-space:pre">	var l = labelsCount;</td></tr><tr class="success"><td>650</td><td>1</td><td style="border-top:none;white-space:pre">	var i = 0;</td></tr><tr ><td>651</td><td></td><td style="border-top:none;white-space:pre">	// Счетчик имен сборок-утверждений</td></tr><tr class="success"><td>652</td><td>1</td><td style="border-top:none;white-space:pre">	var utvCount = 1;</td></tr><tr class="success"><td>653</td><td>1</td><td style="border-top:none;white-space:pre">	while (labelsCount > 0) {</td></tr><tr class="success"><td>654</td><td>1</td><td style="border-top:none;white-space:pre">		this.labelLayer.placedItems.removeAll();</td></tr><tr class="success"><td>655</td><td>1</td><td style="border-top:none;white-space:pre">		for (var k=0; i < l && k < cutsCount; k++, i++) {</td></tr><tr class="success"><td>656</td><td>2</td><td style="border-top:none;white-space:pre">			try {</td></tr><tr ><td>657</td><td></td><td style="border-top:none;white-space:pre">				// Помещаем на слой layer файл этикетки</td></tr><tr class="success"><td>658</td><td>2</td><td style="border-top:none;white-space:pre">				this.placeLabel(cuts[k], this.labels[i]);</td></tr><tr ><td>659</td><td></td><td style="border-top:none;white-space:pre">				// Крутим</td></tr><tr class="success"><td>660</td><td>2</td><td style="border-top:none;white-space:pre">				this.applyStyle();</td></tr><tr ><td>661</td><td></td><td style="border-top:none;white-space:pre">			} catch (e) {</td></tr><tr ><td>662</td><td></td><td style="border-top:none;white-space:pre">				// interrupt normal flow</td></tr><tr class="danger"><td>663</td><td>0</td><td style="border-top:none;white-space:pre">				throw {</td></tr><tr ><td>664</td><td></td><td style="border-top:none;white-space:pre">					message: e.message,</td></tr><tr ><td>665</td><td></td><td style="border-top:none;white-space:pre">					source: 'MatchingImposer',</td></tr><tr ><td>666</td><td></td><td style="border-top:none;white-space:pre">					file: this.labels[i].fullName,</td></tr><tr ><td>667</td><td></td><td style="border-top:none;white-space:pre">					severity: 'error',</td></tr><tr ><td>668</td><td></td><td style="border-top:none;white-space:pre">					jobid: this.job.id,</td></tr><tr ><td>669</td><td></td><td style="border-top:none;white-space:pre">				};</td></tr><tr ><td>670</td><td></td><td style="border-top:none;white-space:pre">			}</td></tr><tr ><td>671</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr class="success"><td>672</td><td>1</td><td style="border-top:none;white-space:pre">		labelsCount -= cutsCount;</td></tr><tr ><td>673</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>674</td><td></td><td style="border-top:none;white-space:pre">		// Экспорт сборки на сервер</td></tr><tr class="success"><td>675</td><td>1</td><td style="border-top:none;white-space:pre">		this.exportPDF(this.getPDFName(utvCount));</td></tr><tr ><td>676</td><td></td><td style="border-top:none;white-space:pre">		 </td></tr><tr ><td>677</td><td></td><td style="border-top:none;white-space:pre">		// Экспорт сборки в горячую папку на RIP</td></tr><tr class="success"><td>678</td><td>1</td><td style="border-top:none;white-space:pre">		this.sendtoHotFolder();</td></tr><tr class="success"><td>679</td><td>1</td><td style="border-top:none;white-space:pre">		utvCount++;</td></tr><tr ><td>680</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr ><td>681</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>682</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>683</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>684</td><td></td><td style="border-top:none;white-space:pre"> * Возвращает имя файла для экспорта в PDF</td></tr><tr ><td>685</td><td></td><td style="border-top:none;white-space:pre"> * Сборка должна падать в папку с первой этикеткой задания</td></tr><tr ><td>686</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>687</td><td></td><td style="border-top:none;white-space:pre"> * @param {number} index Номер файла</td></tr><tr ><td>688</td><td></td><td style="border-top:none;white-space:pre"> * @param {string} range Диапазон папок</td></tr><tr ><td>689</td><td></td><td style="border-top:none;white-space:pre"> * @param {string} cName Чё за хрень не помню</td></tr><tr ><td>690</td><td></td><td style="border-top:none;white-space:pre"> * @return {string} Имя файла</td></tr><tr ><td>691</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>692</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.MatchingImposer.prototype.getPDFPart = function(index, range, cName) {</td></tr><tr class="success"><td>693</td><td>1</td><td style="border-top:none;white-space:pre">	return this.labels[0].parent + '\\' + cName + range + '_UTV_' + index.toString() + '.pdf';</td></tr><tr ><td>694</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>695</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>696</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>697</td><td></td><td style="border-top:none;white-space:pre"> * @classdesc Сканирование папки шаблонов с целью создания базы в монго</td></tr><tr ><td>698</td><td></td><td style="border-top:none;white-space:pre"> * @constructor</td></tr><tr ><td>699</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>700</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.TemplateScanner = function() {};</td></tr><tr class="success"><td>701</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.TemplateScanner.prototype = new Indigo.BaseImposer(app);</td></tr><tr class="success"><td>702</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.TemplateScanner.prototype.constructor = Indigo.TemplateScanner;</td></tr><tr ><td>703</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>704</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.TemplateScanner.prototype.currentLabel = null;</td></tr><tr class="success"><td>705</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.TemplateScanner.prototype.name = 'TemplateScanner';</td></tr><tr ><td>706</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>707</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>708</td><td></td><td style="border-top:none;white-space:pre"> * Реализация run() из BaseImposer</td></tr><tr ><td>709</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>710</td><td></td><td style="border-top:none;white-space:pre"> * @return {Object} result Список имён шаблонов с размерами этикетки</td></tr><tr ><td>711</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>712</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.TemplateScanner.prototype.run = function () {</td></tr><tr ><td>713</td><td></td><td style="border-top:none;white-space:pre">	// Размер буфера, по умолчанию 50	</td></tr><tr class="success"><td>714</td><td>1</td><td style="border-top:none;white-space:pre">	var chunkSize = this.chunkSize ? this.chunkSize : 50;</td></tr><tr ><td>715</td><td></td><td style="border-top:none;white-space:pre">	</td></tr><tr ><td>716</td><td></td><td style="border-top:none;white-space:pre">	// Заполнение массива шаблонов</td></tr><tr class="success"><td>717</td><td>1</td><td style="border-top:none;white-space:pre">	this.getTemplates();</td></tr><tr ><td>718</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>719</td><td>1</td><td style="border-top:none;white-space:pre">	var templatesHeap = [],</td></tr><tr ><td>720</td><td></td><td style="border-top:none;white-space:pre">		affected = this.templates.length;</td></tr><tr ><td>721</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>722</td><td></td><td style="border-top:none;white-space:pre">	//</td></tr><tr ><td>723</td><td></td><td style="border-top:none;white-space:pre">	// Передача промежуточных результатов </td></tr><tr ><td>724</td><td></td><td style="border-top:none;white-space:pre">	//</td></tr><tr class="success"><td>725</td><td>1</td><td style="border-top:none;white-space:pre">	function sendChunk(piece) {</td></tr><tr class="success"><td>726</td><td>2</td><td style="border-top:none;white-space:pre">		var success = true;</td></tr><tr class="success"><td>727</td><td>2</td><td style="border-top:none;white-space:pre">		try {</td></tr><tr class="success"><td>728</td><td>2</td><td style="border-top:none;white-space:pre">			this.send(piece);</td></tr><tr ><td>729</td><td></td><td style="border-top:none;white-space:pre">		} catch (e) {</td></tr><tr class="danger"><td>730</td><td>0</td><td style="border-top:none;white-space:pre">			success = false;</td></tr><tr ><td>731</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr class="success"><td>732</td><td>2</td><td style="border-top:none;white-space:pre">		return success;</td></tr><tr ><td>733</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr ><td>734</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>735</td><td></td><td style="border-top:none;white-space:pre">	// Массив templates.length будет сокращаться на 1 с каждым</td></tr><tr ><td>736</td><td></td><td style="border-top:none;white-space:pre">	// проходом цикла. Поэтому итератор написан схожим образом.</td></tr><tr ><td>737</td><td></td><td style="border-top:none;white-space:pre">	// Каждые `chunkSize` проходов цикла будет происходить сброс </td></tr><tr ><td>738</td><td></td><td style="border-top:none;white-space:pre">	// результатов в базу.</td></tr><tr class="success"><td>739</td><td>1</td><td style="border-top:none;white-space:pre">	for (var i = this.templates.length, chsz = 1; i > 0; i--, chsz++) {</td></tr><tr class="success"><td>740</td><td>3</td><td style="border-top:none;white-space:pre">		var t = this.openTemplate();</td></tr><tr ><td>741</td><td></td><td style="border-top:none;white-space:pre">		</td></tr><tr class="success"><td>742</td><td>3</td><td style="border-top:none;white-space:pre">		var info = {};</td></tr><tr class="success"><td>743</td><td>3</td><td style="border-top:none;white-space:pre">		info.name = this.temp.name.replace('.ait','');</td></tr><tr ><td>744</td><td></td><td style="border-top:none;white-space:pre">	</td></tr><tr class="success"><td>745</td><td>3</td><td style="border-top:none;white-space:pre">		var valid = this.validate();</td></tr><tr class="success"><td>746</td><td>3</td><td style="border-top:none;white-space:pre">		if (valid.length > 0) {</td></tr><tr class="success"><td>747</td><td>2</td><td style="border-top:none;white-space:pre">			info.status = 'error';</td></tr><tr class="success"><td>748</td><td>2</td><td style="border-top:none;white-space:pre">			info.errors = valid;</td></tr><tr ><td>749</td><td></td><td style="border-top:none;white-space:pre">		} else {</td></tr><tr class="success"><td>750</td><td>1</td><td style="border-top:none;white-space:pre">			var c = this.getLowerCut();</td></tr><tr class="success"><td>751</td><td>1</td><td style="border-top:none;white-space:pre">			info.width = Indigo.round3(c.width);</td></tr><tr class="success"><td>752</td><td>1</td><td style="border-top:none;white-space:pre">			info.height = Indigo.round3(c.height);</td></tr><tr class="success"><td>753</td><td>1</td><td style="border-top:none;white-space:pre">			info.status = 'done';</td></tr><tr ><td>754</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr class="success"><td>755</td><td>3</td><td style="border-top:none;white-space:pre">		templatesHeap.push(info);</td></tr><tr class="success"><td>756</td><td>3</td><td style="border-top:none;white-space:pre">		t.close();</td></tr><tr ><td>757</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>758</td><td>3</td><td style="border-top:none;white-space:pre">		if (chsz >= chunkSize) {</td></tr><tr class="success"><td>759</td><td>1</td><td style="border-top:none;white-space:pre">			chsz = 0;</td></tr><tr class="success"><td>760</td><td>1</td><td style="border-top:none;white-space:pre">			if (sendChunk.call(this, templatesHeap)) {</td></tr><tr class="success"><td>761</td><td>1</td><td style="border-top:none;white-space:pre">				templatesHeap = [];</td></tr><tr ><td>762</td><td></td><td style="border-top:none;white-space:pre">			}</td></tr><tr ><td>763</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr ><td>764</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr ><td>765</td><td></td><td style="border-top:none;white-space:pre">	// Добиваем остатки, если есть</td></tr><tr class="success"><td>766</td><td>1</td><td style="border-top:none;white-space:pre">	if (templatesHeap.length > 0) {</td></tr><tr class="success"><td>767</td><td>1</td><td style="border-top:none;white-space:pre">		sendChunk.call(this, templatesHeap);</td></tr><tr ><td>768</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr ><td>769</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>770</td><td>1</td><td style="border-top:none;white-space:pre">	return {completed: 'victory', affected: affected};</td></tr><tr ><td>771</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>772</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>773</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>774</td><td></td><td style="border-top:none;white-space:pre"> * aihint для шаблона</td></tr><tr ><td>775</td><td></td><td style="border-top:none;white-space:pre"> * </td></tr><tr ><td>776</td><td></td><td style="border-top:none;white-space:pre"> * проверка наличия необходимых слоёв и графических стилей</td></tr><tr ><td>777</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>778</td><td></td><td style="border-top:none;white-space:pre"> * @return {array} errors </td></tr><tr ><td>779</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>780</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.TemplateScanner.prototype.validate = function () {</td></tr><tr class="success"><td>781</td><td>3</td><td style="border-top:none;white-space:pre">	var t = this.template;</td></tr><tr class="success"><td>782</td><td>3</td><td style="border-top:none;white-space:pre">	var errors = [];</td></tr><tr ><td>783</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>784</td><td>3</td><td style="border-top:none;white-space:pre">	if (t.layers.length > 2) {</td></tr><tr class="danger"><td>785</td><td>0</td><td style="border-top:none;white-space:pre">		errors.push('More than two layers in template');</td></tr><tr ><td>786</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr class="success"><td>787</td><td>3</td><td style="border-top:none;white-space:pre">	var expectedLayers = ['cut', 'mark'];</td></tr><tr class="success"><td>788</td><td>3</td><td style="border-top:none;white-space:pre">	for (var il = 0, ll = expectedLayers.length; il < ll; il++) {</td></tr><tr class="success"><td>789</td><td>6</td><td style="border-top:none;white-space:pre">		try {</td></tr><tr class="success"><td>790</td><td>6</td><td style="border-top:none;white-space:pre">			var expectedLayer = t.layers[expectedLayers[il]];</td></tr><tr ><td>791</td><td></td><td style="border-top:none;white-space:pre">		} catch (e) {</td></tr><tr class="success"><td>792</td><td>1</td><td style="border-top:none;white-space:pre">			errors.push('No "' + expectedLayers[il] + '" layer in template');</td></tr><tr ><td>793</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr ><td>794</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr ><td>795</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>796</td><td>3</td><td style="border-top:none;white-space:pre">	if (t.graphicStyles.length !== 6) {</td></tr><tr class="success"><td>797</td><td>1</td><td style="border-top:none;white-space:pre">		errors.push('Rolls unstable');</td></tr><tr ><td>798</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr class="success"><td>799</td><td>3</td><td style="border-top:none;white-space:pre">	var expectedStyles = ['roll_1_6', 'roll_2_5', 'roll_3_7', 'roll_4_8'];</td></tr><tr class="success"><td>800</td><td>3</td><td style="border-top:none;white-space:pre">	for (var is = 0, ls = expectedStyles.length; is < ls; is++) {</td></tr><tr class="success"><td>801</td><td>12</td><td style="border-top:none;white-space:pre">		try {</td></tr><tr class="success"><td>802</td><td>12</td><td style="border-top:none;white-space:pre">			var expectedStyle = t.graphicStyles[expectedStyles[is]];</td></tr><tr ><td>803</td><td></td><td style="border-top:none;white-space:pre">		} catch (e) {</td></tr><tr class="success"><td>804</td><td>1</td><td style="border-top:none;white-space:pre">			errors.push('Roll "' + expectedStyles[is] + '" absent');</td></tr><tr ><td>805</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr ><td>806</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr class="success"><td>807</td><td>3</td><td style="border-top:none;white-space:pre">	return errors;</td></tr><tr ><td>808</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>809</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>810</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>811</td><td></td><td style="border-top:none;white-space:pre"> * Создание массива шаблонов</td></tr><tr ><td>812</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>813</td><td></td><td style="border-top:none;white-space:pre"> * На рекурсию не замарачиваемся, предполагаем, что все  </td></tr><tr ><td>814</td><td></td><td style="border-top:none;white-space:pre"> * шаблоны лежат в корне templateFolder с расширением .ait</td></tr><tr ><td>815</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>816</td><td></td><td style="border-top:none;white-space:pre"> * Шаблоны, которые уже есть в базе отфильтровываются</td></tr><tr ><td>817</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>818</td><td></td><td style="border-top:none;white-space:pre"> * @throws {customException} Нет папки с шаблонами</td></tr><tr ><td>819</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>820</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.TemplateScanner.prototype.getTemplates = function() {</td></tr><tr class="success"><td>821</td><td>5</td><td style="border-top:none;white-space:pre">	if (this.templateFolder.exists) {</td></tr><tr ><td>822</td><td></td><td style="border-top:none;white-space:pre">		// Все шаблоны с диска:</td></tr><tr class="success"><td>823</td><td>4</td><td style="border-top:none;white-space:pre">		var whole = this.templateFolder.getFiles('*.ait').sort();</td></tr><tr ><td>824</td><td></td><td style="border-top:none;white-space:pre">		// Массив шаблонов, которые уже обработаны:</td></tr><tr class="success"><td>825</td><td>4</td><td style="border-top:none;white-space:pre">		var ready = this.job.templates.sort();</td></tr><tr ><td>826</td><td></td><td style="border-top:none;white-space:pre">		// Отфильтрованный массив шаблонов:</td></tr><tr class="success"><td>827</td><td>4</td><td style="border-top:none;white-space:pre">		var todo = [];</td></tr><tr ><td>828</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>829</td><td>4</td><td style="border-top:none;white-space:pre">		for (var i = 0, l = whole.length; i < l; i++) {</td></tr><tr class="success"><td>830</td><td>12</td><td style="border-top:none;white-space:pre">			var name = whole[i].name.replace('.ait','');</td></tr><tr class="success"><td>831</td><td>12</td><td style="border-top:none;white-space:pre">			if (!ready.contains(name)) {</td></tr><tr class="success"><td>832</td><td>7</td><td style="border-top:none;white-space:pre">				todo.push(whole[i]);</td></tr><tr ><td>833</td><td></td><td style="border-top:none;white-space:pre">			}</td></tr><tr ><td>834</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr class="success"><td>835</td><td>4</td><td style="border-top:none;white-space:pre">		this.templates = todo;</td></tr><tr ><td>836</td><td></td><td style="border-top:none;white-space:pre">	} else {</td></tr><tr class="success"><td>837</td><td>1</td><td style="border-top:none;white-space:pre">		throw {</td></tr><tr ><td>838</td><td></td><td style="border-top:none;white-space:pre">			message: 'Template folder not found',</td></tr><tr ><td>839</td><td></td><td style="border-top:none;white-space:pre">			file: this.templateFolder.fullName,</td></tr><tr ><td>840</td><td></td><td style="border-top:none;white-space:pre">			jobid: this.job._id,</td></tr><tr ><td>841</td><td></td><td style="border-top:none;white-space:pre">		};</td></tr><tr ><td>842</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr ><td>843</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>844</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>845</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>846</td><td></td><td style="border-top:none;white-space:pre"> * Получение файла шаблона из массива шаблонов</td></tr><tr ><td>847</td><td></td><td style="border-top:none;white-space:pre"> * Реализация getTemplateName() из BaseImposer</td></tr><tr ><td>848</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>849</td><td></td><td style="border-top:none;white-space:pre"> * @return {File} Файл шаблона</td></tr><tr ><td>850</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>851</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.TemplateScanner.prototype.getTemplateName = function() {</td></tr><tr class="success"><td>852</td><td>3</td><td style="border-top:none;white-space:pre">	var t = this.templates.shift();</td></tr><tr ><td>853</td><td></td><td style="border-top:none;white-space:pre">	// Сохраним текущий шаблон в экземплярной переменной,</td></tr><tr ><td>854</td><td></td><td style="border-top:none;white-space:pre">	// чтобы в дальнейшем получить с него имя</td></tr><tr class="success"><td>855</td><td>3</td><td style="border-top:none;white-space:pre">	this.temp = t;</td></tr><tr class="success"><td>856</td><td>3</td><td style="border-top:none;white-space:pre">	return t;</td></tr><tr ><td>857</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>858</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>859</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>860</td><td></td><td style="border-top:none;white-space:pre"> * @classdesc Суперкласс для обмена данными между </td></tr><tr ><td>861</td><td></td><td style="border-top:none;white-space:pre"> * Adobe Bridge/ESTK и внешним контроллером</td></tr><tr ><td>862</td><td></td><td style="border-top:none;white-space:pre"> * @constructor</td></tr><tr ><td>863</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>864</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.DataBroker = function() {};</td></tr><tr ><td>865</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>866</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>867</td><td></td><td style="border-top:none;white-space:pre"> * @prop {string} tempPath </td></tr><tr ><td>868</td><td></td><td style="border-top:none;white-space:pre"> * @protected</td></tr><tr ><td>869</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>870</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.DataBroker.prototype.tempPath = '/w/tmp/';</td></tr><tr ><td>871</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>872</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>873</td><td></td><td style="border-top:none;white-space:pre"> * @prop {string} httpPart Выделим отедльный маршрут для передачи данных </td></tr><tr ><td>874</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>875</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.DataBroker.prototype.httpPart = 'data/';</td></tr><tr ><td>876</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>877</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>878</td><td></td><td style="border-top:none;white-space:pre"> * Сериализация объекта в согласованный формат</td></tr><tr ><td>879</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>880</td><td></td><td style="border-top:none;white-space:pre"> * @abstract</td></tr><tr ><td>881</td><td></td><td style="border-top:none;white-space:pre"> * @param {object}</td></tr><tr ><td>882</td><td></td><td style="border-top:none;white-space:pre"> * @return {string}</td></tr><tr ><td>883</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>884</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.DataBroker.prototype.encode = function(obj) {</td></tr><tr class="danger"><td>885</td><td>0</td><td style="border-top:none;white-space:pre">	return 'This method must be overloaded in subclass';</td></tr><tr ><td>886</td><td></td><td style="border-top:none;white-space:pre">},</td></tr><tr ><td>887</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>888</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>889</td><td></td><td style="border-top:none;white-space:pre"> * Реконструкция объекта из строки</td></tr><tr ><td>890</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>891</td><td></td><td style="border-top:none;white-space:pre"> * @abstract</td></tr><tr ><td>892</td><td></td><td style="border-top:none;white-space:pre"> * @param {string}</td></tr><tr ><td>893</td><td></td><td style="border-top:none;white-space:pre"> * @return {object}</td></tr><tr ><td>894</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr ><td>895</td><td></td><td style="border-top:none;white-space:pre">Indigo.DataBroker.prototype.decode = function(string) {</td></tr><tr class="danger"><td>896</td><td>0</td><td style="border-top:none;white-space:pre">	return 'This method must be overloaded in subclass';</td></tr><tr ><td>897</td><td></td><td style="border-top:none;white-space:pre">},</td></tr><tr ><td>898</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>899</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>900</td><td></td><td style="border-top:none;white-space:pre"> * Относительный адрес, куда брокер отправляет запросы</td></tr><tr ><td>901</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>902</td><td></td><td style="border-top:none;white-space:pre"> * @return {string} URI</td></tr><tr ><td>903</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr ><td>904</td><td></td><td style="border-top:none;white-space:pre">Indigo.DataBroker.prototype.getURI = function() {</td></tr><tr class="danger"><td>905</td><td>0</td><td style="border-top:none;white-space:pre">	return this.httpPart + this.type + "/";</td></tr><tr ><td>906</td><td></td><td style="border-top:none;white-space:pre">},</td></tr><tr ><td>907</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>908</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>909</td><td></td><td style="border-top:none;white-space:pre"> * Сохранение объекта в файл</td></tr><tr ><td>910</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>911</td><td></td><td style="border-top:none;white-space:pre"> * @param {object} obj Объект для сохранения</td></tr><tr ><td>912</td><td></td><td style="border-top:none;white-space:pre"> * @protected</td></tr><tr ><td>913</td><td></td><td style="border-top:none;white-space:pre"> * @return {void}</td></tr><tr ><td>914</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr ><td>915</td><td></td><td style="border-top:none;white-space:pre">Indigo.DataBroker.prototype.saveObj = function(obj) {</td></tr><tr class="success"><td>916</td><td>1</td><td style="border-top:none;white-space:pre">	var jobFile = new File(this.tempPath + this.type + 'Obj.txt');</td></tr><tr class="success"><td>917</td><td>1</td><td style="border-top:none;white-space:pre">	jobFile.open('w');</td></tr><tr class="success"><td>918</td><td>1</td><td style="border-top:none;white-space:pre">	jobFile.write (obj.toSource());</td></tr><tr class="success"><td>919</td><td>1</td><td style="border-top:none;white-space:pre">	jobFile.close();</td></tr><tr ><td>920</td><td></td><td style="border-top:none;white-space:pre">},</td></tr><tr ><td>921</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>922</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>923</td><td></td><td style="border-top:none;white-space:pre"> * Сохранение строки в файл</td></tr><tr ><td>924</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>925</td><td></td><td style="border-top:none;white-space:pre"> * @param {string} string </td></tr><tr ><td>926</td><td></td><td style="border-top:none;white-space:pre"> * @protected</td></tr><tr ><td>927</td><td></td><td style="border-top:none;white-space:pre"> * @return {void}</td></tr><tr ><td>928</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr ><td>929</td><td></td><td style="border-top:none;white-space:pre">Indigo.DataBroker.prototype.saveString = function(string) {</td></tr><tr class="success"><td>930</td><td>1</td><td style="border-top:none;white-space:pre">	var jobFile = new File(this.tempPath + this.type + 'String.txt');</td></tr><tr class="success"><td>931</td><td>1</td><td style="border-top:none;white-space:pre">	jobFile.open('w');</td></tr><tr class="success"><td>932</td><td>1</td><td style="border-top:none;white-space:pre">	jobFile.write (string);</td></tr><tr class="success"><td>933</td><td>1</td><td style="border-top:none;white-space:pre">	jobFile.close();</td></tr><tr ><td>934</td><td></td><td style="border-top:none;white-space:pre">},</td></tr><tr ><td>935</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>936</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>937</td><td></td><td style="border-top:none;white-space:pre"> * Загрузка строки из файла</td></tr><tr ><td>938</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>939</td><td></td><td style="border-top:none;white-space:pre"> * @protected</td></tr><tr ><td>940</td><td></td><td style="border-top:none;white-space:pre"> * @return {string}</td></tr><tr ><td>941</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr ><td>942</td><td></td><td style="border-top:none;white-space:pre">Indigo.DataBroker.prototype.loadJob = function() {</td></tr><tr class="danger"><td>943</td><td>0</td><td style="border-top:none;white-space:pre">	var jobFile = new File(this.tempPath + this.type + 'String.txt');</td></tr><tr class="danger"><td>944</td><td>0</td><td style="border-top:none;white-space:pre">	jobFile.open('r');</td></tr><tr class="danger"><td>945</td><td>0</td><td style="border-top:none;white-space:pre">	var jobSource = jobFile.read();</td></tr><tr class="danger"><td>946</td><td>0</td><td style="border-top:none;white-space:pre">	jobFile.close();</td></tr><tr class="danger"><td>947</td><td>0</td><td style="border-top:none;white-space:pre">	return jobSource;</td></tr><tr ><td>948</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>949</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>950</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>951</td><td></td><td style="border-top:none;white-space:pre"> * @classdesc Реализация обмена данными в формате json </td></tr><tr ><td>952</td><td></td><td style="border-top:none;white-space:pre"> * для Adobe CS3</td></tr><tr ><td>953</td><td></td><td style="border-top:none;white-space:pre"> * @constructor</td></tr><tr ><td>954</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>955</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.JsonBroker = function() {};</td></tr><tr ><td>956</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>957</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.JsonBroker.prototype = new Indigo.DataBroker();</td></tr><tr class="success"><td>958</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.JsonBroker.prototype.constructor = Indigo.JsonBroker;</td></tr><tr class="success"><td>959</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.JsonBroker.prototype.type = 'json';</td></tr><tr ><td>960</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>961</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>962</td><td></td><td style="border-top:none;white-space:pre"> * Реализация интерфейса Indigo.DataBroker </td></tr><tr ><td>963</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>964</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.JsonBroker.prototype.encode = function (obj) {</td></tr><tr class="success"><td>965</td><td>1</td><td style="border-top:none;white-space:pre">	return this.toJSON(obj);</td></tr><tr ><td>966</td><td></td><td style="border-top:none;white-space:pre">},</td></tr><tr ><td>967</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>968</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>969</td><td></td><td style="border-top:none;white-space:pre"> * Реализация интерфейса Indigo.DataBroker </td></tr><tr ><td>970</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr ><td>971</td><td></td><td style="border-top:none;white-space:pre">Indigo.JsonBroker.prototype.decode = function (string) {</td></tr><tr class="success"><td>972</td><td>2</td><td style="border-top:none;white-space:pre">	return this.fromJSON(string);</td></tr><tr ><td>973</td><td></td><td style="border-top:none;white-space:pre">},</td></tr><tr ><td>974</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>975</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>976</td><td></td><td style="border-top:none;white-space:pre"> * Сериализация объекта Adobe JavaScript CS3 в формат JSON, понятный остальным </td></tr><tr ><td>977</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>978</td><td></td><td style="border-top:none;white-space:pre"> * @param {object} obj Объект под сериализацию</td></tr><tr ><td>979</td><td></td><td style="border-top:none;white-space:pre"> * @return {string} parcel Валидный json</td></tr><tr ><td>980</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr ><td>981</td><td></td><td style="border-top:none;white-space:pre">Indigo.JsonBroker.prototype.toJSON = function (obj) {</td></tr><tr class="success"><td>982</td><td>1</td><td style="border-top:none;white-space:pre">	this.saveObj(obj);</td></tr><tr class="success"><td>983</td><td>1</td><td style="border-top:none;white-space:pre">	var jsonString = '';</td></tr><tr class="success"><td>984</td><td>1</td><td style="border-top:none;white-space:pre">	var parcel = '{' + this.json_encode(obj, jsonString) + '}';</td></tr><tr class="success"><td>985</td><td>1</td><td style="border-top:none;white-space:pre">	return parcel;</td></tr><tr ><td>986</td><td></td><td style="border-top:none;white-space:pre">},</td></tr><tr ><td>987</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>988</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>989</td><td></td><td style="border-top:none;white-space:pre"> * @desc Восстановление объекта JavaScipt из json-строки. </td></tr><tr ><td>990</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>991</td><td></td><td style="border-top:none;white-space:pre"> * @param {string} string Сериализованный объект</td></tr><tr ><td>992</td><td></td><td style="border-top:none;white-space:pre"> * @return {object} obj Объект JavaScript</td></tr><tr ><td>993</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr ><td>994</td><td></td><td style="border-top:none;white-space:pre">Indigo.JsonBroker.prototype.fromJSON = function(string) {</td></tr><tr class="success"><td>995</td><td>2</td><td style="border-top:none;white-space:pre">	try {</td></tr><tr class="success"><td>996</td><td>2</td><td style="border-top:none;white-space:pre">		var obj = eval( '(' + string + ')' );</td></tr><tr class="success"><td>997</td><td>1</td><td style="border-top:none;white-space:pre">		return this.json_decode(obj);</td></tr><tr ><td>998</td><td></td><td style="border-top:none;white-space:pre">	} catch (e) {</td></tr><tr class="success"><td>999</td><td>1</td><td style="border-top:none;white-space:pre">		this.saveString(string);</td></tr><tr ><td>1000</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr ><td>1001</td><td></td><td style="border-top:none;white-space:pre">},</td></tr><tr ><td>1002</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1003</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>1004</td><td></td><td style="border-top:none;white-space:pre"> * Protected functions</td></tr><tr ><td>1005</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr ><td>1006</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1007</td><td></td><td style="border-top:none;white-space:pre">Indigo.JsonBroker.prototype.json_decode = function(obj) {</td></tr><tr class="success"><td>1008</td><td>1</td><td style="border-top:none;white-space:pre">	for (var key in obj) {</td></tr><tr class="success"><td>1009</td><td>2</td><td style="border-top:none;white-space:pre">		if (obj.hasOwnProperty(key)) {</td></tr><tr class="success"><td>1010</td><td>2</td><td style="border-top:none;white-space:pre">			if (typeof(obj[key]) === 'string') {</td></tr><tr class="success"><td>1011</td><td>1</td><td style="border-top:none;white-space:pre">				obj[key] = decodeURIComponent(obj[key]);</td></tr><tr ><td>1012</td><td></td><td style="border-top:none;white-space:pre">			}</td></tr><tr class="success"><td>1013</td><td>2</td><td style="border-top:none;white-space:pre">			if (typeof(obj[key]) === 'object') {</td></tr><tr class="danger"><td>1014</td><td>0</td><td style="border-top:none;white-space:pre">				obj[key] = this.json_decode(obj[key]);</td></tr><tr ><td>1015</td><td></td><td style="border-top:none;white-space:pre">			}</td></tr><tr ><td>1016</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr ><td>1017</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr class="success"><td>1018</td><td>1</td><td style="border-top:none;white-space:pre">	return obj;</td></tr><tr ><td>1019</td><td></td><td style="border-top:none;white-space:pre">},</td></tr><tr ><td>1020</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1021</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>1022</td><td></td><td style="border-top:none;white-space:pre"> * Преобразование объекта в json формат. </td></tr><tr ><td>1023</td><td></td><td style="border-top:none;white-space:pre"> * Рекурсивно обходит свойства объекта и хлопает их в строку.</td></tr><tr ><td>1024</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>1025</td><td></td><td style="border-top:none;white-space:pre"> * Херовая реализация, первый кандидат на рефакторинг</td></tr><tr ><td>1026</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>1027</td><td></td><td style="border-top:none;white-space:pre"> * @param {object} obj Объект сериализации</td></tr><tr ><td>1028</td><td></td><td style="border-top:none;white-space:pre"> * @param {string} jsonString Накопительная переменная для хранения промежуточных результатов </td></tr><tr ><td>1029</td><td></td><td style="border-top:none;white-space:pre"> * @return {string} js Строка json</td></tr><tr ><td>1030</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr ><td>1031</td><td></td><td style="border-top:none;white-space:pre">Indigo.JsonBroker.prototype.json_encode = function(obj, jsonString) {</td></tr><tr class="success"><td>1032</td><td>7</td><td style="border-top:none;white-space:pre">	for(var i in obj) {</td></tr><tr class="success"><td>1033</td><td>17</td><td style="border-top:none;white-space:pre">		if (obj.hasOwnProperty(i)) {</td></tr><tr class="success"><td>1034</td><td>15</td><td style="border-top:none;white-space:pre">			var Pocient = obj[i];</td></tr><tr class="success"><td>1035</td><td>15</td><td style="border-top:none;white-space:pre">			if (typeof(Pocient) === 'undefined') {</td></tr><tr class="danger"><td>1036</td><td>0</td><td style="border-top:none;white-space:pre">				jsonString += '"' + i + '":"undefined",';</td></tr><tr class="danger"><td>1037</td><td>0</td><td style="border-top:none;white-space:pre">				continue;</td></tr><tr ><td>1038</td><td></td><td style="border-top:none;white-space:pre">			}</td></tr><tr class="success"><td>1039</td><td>15</td><td style="border-top:none;white-space:pre">			if (Pocient instanceof Array) {</td></tr><tr class="success"><td>1040</td><td>2</td><td style="border-top:none;white-space:pre">				jsonString += '"' + i + '":' + '[' + this.json_encode(Pocient, '') + '],';</td></tr><tr class="success"><td>1041</td><td>2</td><td style="border-top:none;white-space:pre">				continue;</td></tr><tr ><td>1042</td><td></td><td style="border-top:none;white-space:pre">			}</td></tr><tr class="success"><td>1043</td><td>13</td><td style="border-top:none;white-space:pre">			if (typeof(Pocient) === "number") {</td></tr><tr class="success"><td>1044</td><td>2</td><td style="border-top:none;white-space:pre">				jsonString += '"' + i + '":' + Pocient + ',';</td></tr><tr class="success"><td>1045</td><td>2</td><td style="border-top:none;white-space:pre">				continue;</td></tr><tr ><td>1046</td><td></td><td style="border-top:none;white-space:pre">			}</td></tr><tr class="success"><td>1047</td><td>11</td><td style="border-top:none;white-space:pre">			if (Pocient instanceof Object) {</td></tr><tr class="success"><td>1048</td><td>4</td><td style="border-top:none;white-space:pre">				if (obj instanceof Array) {</td></tr><tr class="success"><td>1049</td><td>3</td><td style="border-top:none;white-space:pre">					jsonString += '{' + this.json_encode(Pocient, '') + '},';</td></tr><tr ><td>1050</td><td></td><td style="border-top:none;white-space:pre">				} else {</td></tr><tr class="success"><td>1051</td><td>1</td><td style="border-top:none;white-space:pre">					jsonString += '"' + i + '":' + '{' + this.json_encode(Pocient, '') + '},';</td></tr><tr ><td>1052</td><td></td><td style="border-top:none;white-space:pre">				}</td></tr><tr class="success"><td>1053</td><td>4</td><td style="border-top:none;white-space:pre">				continue;</td></tr><tr ><td>1054</td><td></td><td style="border-top:none;white-space:pre">			}</td></tr><tr class="success"><td>1055</td><td>7</td><td style="border-top:none;white-space:pre">			if (typeof(Pocient) === 'boolean') {</td></tr><tr class="success"><td>1056</td><td>1</td><td style="border-top:none;white-space:pre">				var jsonBool = Pocient ? "true" : "false";</td></tr><tr class="success"><td>1057</td><td>1</td><td style="border-top:none;white-space:pre">				jsonString += '"' + i + '":' + jsonBool + ',';</td></tr><tr ><td>1058</td><td></td><td style="border-top:none;white-space:pre">			} else {</td></tr><tr ><td>1059</td><td></td><td style="border-top:none;white-space:pre">				// Будем считать, что это string</td></tr><tr ><td>1060</td><td></td><td style="border-top:none;white-space:pre">				// Напрааа-во!</td></tr><tr ><td>1061</td><td></td><td style="border-top:none;white-space:pre">				// (Повернуть все слэши в "нужную" сторону, чтоб не париться на стороне сервера)</td></tr><tr class="success"><td>1062</td><td>6</td><td style="border-top:none;white-space:pre">				var slashString = Pocient.replace(/\\/g,'/');</td></tr><tr ><td>1063</td><td></td><td style="border-top:none;white-space:pre">				//</td></tr><tr class="success"><td>1064</td><td>6</td><td style="border-top:none;white-space:pre">				var cleanString = slashString.toSource().replace('(new String(','').replace('))','');</td></tr><tr class="success"><td>1065</td><td>6</td><td style="border-top:none;white-space:pre">				if (obj instanceof Array) {</td></tr><tr ><td>1066</td><td></td><td style="border-top:none;white-space:pre">					// Числовые индексы массива нам тут нахрен не нужны</td></tr><tr class="success"><td>1067</td><td>2</td><td style="border-top:none;white-space:pre">					jsonString += cleanString + ',';</td></tr><tr ><td>1068</td><td></td><td style="border-top:none;white-space:pre">				} else {</td></tr><tr ><td>1069</td><td></td><td style="border-top:none;white-space:pre">					// А вот имена свойств объектов или переменных -- всегда пожалуйста</td></tr><tr class="success"><td>1070</td><td>4</td><td style="border-top:none;white-space:pre">					jsonString += '"' + i + '":' + cleanString + ',';</td></tr><tr ><td>1071</td><td></td><td style="border-top:none;white-space:pre">				}</td></tr><tr class="success"><td>1072</td><td>6</td><td style="border-top:none;white-space:pre">				continue;</td></tr><tr ><td>1073</td><td></td><td style="border-top:none;white-space:pre">			}</td></tr><tr ><td>1074</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr ><td>1075</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr ><td>1076</td><td></td><td style="border-top:none;white-space:pre">	// remove last comma</td></tr><tr class="success"><td>1077</td><td>7</td><td style="border-top:none;white-space:pre">	var b = jsonString.lastIndexOf(',');</td></tr><tr class="success"><td>1078</td><td>7</td><td style="border-top:none;white-space:pre">	var js = jsonString.substr(0,b);</td></tr><tr ><td>1079</td><td></td><td style="border-top:none;white-space:pre">	</td></tr><tr class="success"><td>1080</td><td>7</td><td style="border-top:none;white-space:pre">	return js;</td></tr><tr ><td>1081</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>1082</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1083</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>1084</td><td></td><td style="border-top:none;white-space:pre"> * @classdesc Суперкласс для обмена сообщениями между</td></tr><tr ><td>1085</td><td></td><td style="border-top:none;white-space:pre"> * Иллюстратором и фронтэндом.</td></tr><tr ><td>1086</td><td></td><td style="border-top:none;white-space:pre"> * Фронтенд может быть любой: веб-сервер, Adobe UI или </td></tr><tr ><td>1087</td><td></td><td style="border-top:none;white-space:pre"> * просто логгер в текстовый файл.</td></tr><tr ><td>1088</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>1089</td><td></td><td style="border-top:none;white-space:pre"> * @constructor</td></tr><tr ><td>1090</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>1091</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.Messenger = function() {};</td></tr><tr ><td>1092</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1093</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>1094</td><td></td><td style="border-top:none;white-space:pre"> * @abstract</td></tr><tr ><td>1095</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>1096</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.Messenger.prototype.setup = function() {</td></tr><tr ><td>1097</td><td></td><td style="border-top:none;white-space:pre">},</td></tr><tr ><td>1098</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1099</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>1100</td><td></td><td style="border-top:none;white-space:pre"> * @abstract</td></tr><tr ><td>1101</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr ><td>1102</td><td></td><td style="border-top:none;white-space:pre">Indigo.Messenger.prototype.send = function(message) {</td></tr><tr ><td>1103</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>1104</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1105</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>1106</td><td></td><td style="border-top:none;white-space:pre"> * @abstract</td></tr><tr ><td>1107</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>1108</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.Messenger.prototype.receive = function() {</td></tr><tr ><td>1109</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>1110</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1111</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>1112</td><td></td><td style="border-top:none;white-space:pre"> * @classdesc Обмен сообщениями по протоколу HTTP между Иллюстратором </td></tr><tr ><td>1113</td><td></td><td style="border-top:none;white-space:pre"> * и неким web-сервером</td></tr><tr ><td>1114</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>1115</td><td></td><td style="border-top:none;white-space:pre"> * @constructor</td></tr><tr ><td>1116</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>1117</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.HTTPMessenger = function(dataBroker) {</td></tr><tr class="success"><td>1118</td><td>2</td><td style="border-top:none;white-space:pre">	this.dataBroker = dataBroker;</td></tr><tr class="success"><td>1119</td><td>2</td><td style="border-top:none;white-space:pre">	this.http = new HttpConnection();</td></tr><tr ><td>1120</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>1121</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>1122</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.HTTPMessenger.prototype = new Indigo.Messenger();</td></tr><tr class="success"><td>1123</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.HTTPMessenger.prototype.constructor = Indigo.HTTPMessenger;</td></tr><tr ><td>1124</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1125</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>1126</td><td></td><td style="border-top:none;white-space:pre"> * @prop {string} remote Адрес Web-сервера</td></tr><tr ><td>1127</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>1128</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.HTTPMessenger.prototype.remote = Indigo.config.webserver;</td></tr><tr ><td>1129</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1130</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>1131</td><td></td><td style="border-top:none;white-space:pre"> * Соединение закрываем в конце цикла жизни приложения</td></tr><tr ><td>1132</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>1133</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.HTTPMessenger.prototype.cleanup = function() {</td></tr><tr class="danger"><td>1134</td><td>0</td><td style="border-top:none;white-space:pre">	this.http.close();</td></tr><tr ><td>1135</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>1136</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1137</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>1138</td><td></td><td style="border-top:none;white-space:pre"> * **Светим наружу метод `http.pump()`**</td></tr><tr ><td>1139</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>1140</td><td></td><td style="border-top:none;white-space:pre"> * Получение данных с асинхронного запроса (`http.async = true`).  </td></tr><tr ><td>1141</td><td></td><td style="border-top:none;white-space:pre"> * Это как-бы для тестов только. В реальных условиях надеюсь *это* не использовать.</td></tr><tr ><td>1142</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>1143</td><td></td><td style="border-top:none;white-space:pre"> * @return {boolean} false -- данные ещё остались</td></tr><tr ><td>1144</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>1145</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.HTTPMessenger.prototype._pump = function() {</td></tr><tr class="success"><td>1146</td><td>3</td><td style="border-top:none;white-space:pre">	var enough = true;</td></tr><tr class="success"><td>1147</td><td>3</td><td style="border-top:none;white-space:pre">	if (this.http.status >= HttpConnection.statusCompleted && this.http.lastread < 0) {</td></tr><tr class="success"><td>1148</td><td>1</td><td style="border-top:none;white-space:pre">		return this.http;</td></tr><tr ><td>1149</td><td></td><td style="border-top:none;white-space:pre">	} else {</td></tr><tr class="success"><td>1150</td><td>2</td><td style="border-top:none;white-space:pre">		this.http.pump();</td></tr><tr class="success"><td>1151</td><td>2</td><td style="border-top:none;white-space:pre">		enough = false;</td></tr><tr ><td>1152</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr class="success"><td>1153</td><td>2</td><td style="border-top:none;white-space:pre">	return enough;</td></tr><tr ><td>1154</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>1155</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1156</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>1157</td><td></td><td style="border-top:none;white-space:pre"> * @param {string} type </td></tr><tr ><td>1158</td><td></td><td style="border-top:none;white-space:pre"> * @param {objects} data JavaScript object</td></tr><tr ><td>1159</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>1160</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.HTTPMessenger.prototype.receive = function(type, data) {</td></tr><tr class="success"><td>1161</td><td>1</td><td style="border-top:none;white-space:pre">	var result = null;</td></tr><tr class="success"><td>1162</td><td>1</td><td style="border-top:none;white-space:pre">	switch(type) {</td></tr><tr ><td>1163</td><td></td><td style="border-top:none;white-space:pre">		case "fetchJobs":</td></tr><tr class="success"><td>1164</td><td>1</td><td style="border-top:none;white-space:pre">			result = this.fetchJobs();</td></tr><tr class="success"><td>1165</td><td>1</td><td style="border-top:none;white-space:pre">		break;</td></tr><tr ><td>1166</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr class="success"><td>1167</td><td>1</td><td style="border-top:none;white-space:pre">	return result;</td></tr><tr ><td>1168</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>1169</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>1170</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.HTTPMessenger.prototype.send = function(type, data) {</td></tr><tr ><td>1171</td><td></td><td style="border-top:none;white-space:pre">	// Установка значений по умолчанию</td></tr><tr class="success"><td>1172</td><td>1</td><td style="border-top:none;white-space:pre">	if (typeof(data.info) === 'undefined') {</td></tr><tr class="success"><td>1173</td><td>1</td><td style="border-top:none;white-space:pre">		data.info = 'finish';</td></tr><tr ><td>1174</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr ><td>1175</td><td></td><td style="border-top:none;white-space:pre">	// Запрос будет асинхронным, если свойство async не установлено явно в false</td></tr><tr class="success"><td>1176</td><td>1</td><td style="border-top:none;white-space:pre">	if (typeof(data.async) === 'undefined') {</td></tr><tr class="danger"><td>1177</td><td>0</td><td style="border-top:none;white-space:pre">		data.async = true;</td></tr><tr ><td>1178</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr ><td>1179</td><td></td><td style="border-top:none;white-space:pre">	// По умолчанию маршрутизация на info, если иное не укзазно явно </td></tr><tr class="success"><td>1180</td><td>1</td><td style="border-top:none;white-space:pre">	if (!type) { </td></tr><tr class="danger"><td>1181</td><td>0</td><td style="border-top:none;white-space:pre">		type = 'info'; </td></tr><tr ><td>1182</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr ><td>1183</td><td></td><td style="border-top:none;white-space:pre">	</td></tr><tr class="success"><td>1184</td><td>1</td><td style="border-top:none;white-space:pre">	data.path = type;</td></tr><tr ><td>1185</td><td></td><td style="border-top:none;white-space:pre">	</td></tr><tr ><td>1186</td><td></td><td style="border-top:none;white-space:pre">	// При возникновении ошибки исходный код пересылать не обязательно</td></tr><tr class="success"><td>1187</td><td>1</td><td style="border-top:none;white-space:pre">	if (type === 'error' && data.source) {</td></tr><tr class="danger"><td>1188</td><td>0</td><td style="border-top:none;white-space:pre">		delete data.source;</td></tr><tr ><td>1189</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr class="success"><td>1190</td><td>1</td><td style="border-top:none;white-space:pre">	this.post(data);</td></tr><tr ><td>1191</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>1192</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1193</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>1194</td><td></td><td style="border-top:none;white-space:pre"> * POST на сервер</td></tr><tr ><td>1195</td><td></td><td style="border-top:none;white-space:pre"> * @protected</td></tr><tr ><td>1196</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>1197</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.HTTPMessenger.prototype.post = function(message) {</td></tr><tr class="success"><td>1198</td><td>1</td><td style="border-top:none;white-space:pre">	var httpPath = this.remote + this.dataBroker.getURI() + message.path;</td></tr><tr class="success"><td>1199</td><td>1</td><td style="border-top:none;white-space:pre">	var http = this.http;</td></tr><tr class="success"><td>1200</td><td>1</td><td style="border-top:none;white-space:pre">	http.url = httpPath;</td></tr><tr class="success"><td>1201</td><td>1</td><td style="border-top:none;white-space:pre">	delete message.path;</td></tr><tr class="success"><td>1202</td><td>1</td><td style="border-top:none;white-space:pre">	if (message.async) {</td></tr><tr class="success"><td>1203</td><td>1</td><td style="border-top:none;white-space:pre">		http.async = true;</td></tr><tr ><td>1204</td><td></td><td style="border-top:none;white-space:pre">		// Если передана колбэк-функция, навесить её</td></tr><tr class="success"><td>1205</td><td>1</td><td style="border-top:none;white-space:pre">		if (typeof(message.callback) === 'function') {</td></tr><tr class="danger"><td>1206</td><td>0</td><td style="border-top:none;white-space:pre">			http.onCallback = message.callback;</td></tr><tr ><td>1207</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr ><td>1208</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr class="success"><td>1209</td><td>1</td><td style="border-top:none;white-space:pre">	var parcel = this.dataBroker.encode(message);</td></tr><tr class="success"><td>1210</td><td>1</td><td style="border-top:none;white-space:pre">	http.mime = "application/x-www-form-urlencoded";</td></tr><tr class="success"><td>1211</td><td>1</td><td style="border-top:none;white-space:pre">	http.requestheaders = ["User-Agent", "Indigo 1.0"];</td></tr><tr class="success"><td>1212</td><td>1</td><td style="border-top:none;white-space:pre">	http.request = 'parcel=' + parcel;</td></tr><tr class="success"><td>1213</td><td>1</td><td style="border-top:none;white-space:pre">	http.method = "POST";</td></tr><tr class="success"><td>1214</td><td>1</td><td style="border-top:none;white-space:pre">	http.execute();</td></tr><tr ><td>1215</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>1216</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1217</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>1218</td><td></td><td style="border-top:none;white-space:pre"> * GET на сервер</td></tr><tr ><td>1219</td><td></td><td style="border-top:none;white-space:pre"> * @protected</td></tr><tr ><td>1220</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>1221</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.HTTPMessenger.prototype.get = function(from) {</td></tr><tr class="success"><td>1222</td><td>1</td><td style="border-top:none;white-space:pre">	var http = this.http;</td></tr><tr class="success"><td>1223</td><td>1</td><td style="border-top:none;white-space:pre">	http.url = encodeURI(from);</td></tr><tr class="success"><td>1224</td><td>1</td><td style="border-top:none;white-space:pre">	http.requestheaders = ["User-Agent", "Indigo 1.0"];</td></tr><tr class="success"><td>1225</td><td>1</td><td style="border-top:none;white-space:pre">	http.execute();</td></tr><tr class="success"><td>1226</td><td>1</td><td style="border-top:none;white-space:pre">	var response = http.response;</td></tr><tr class="success"><td>1227</td><td>1</td><td style="border-top:none;white-space:pre">	return response;</td></tr><tr ><td>1228</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>1229</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1230</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>1231</td><td></td><td style="border-top:none;white-space:pre"> * Parse jobs from remote source to JavaScript job object</td></tr><tr ><td>1232</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>1233</td><td></td><td style="border-top:none;white-space:pre"> * @protected</td></tr><tr ><td>1234</td><td></td><td style="border-top:none;white-space:pre"> * @return {array} data Array of Job objects</td></tr><tr ><td>1235</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>1236</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.HTTPMessenger.prototype.fetchJobs = function() {</td></tr><tr class="success"><td>1237</td><td>1</td><td style="border-top:none;white-space:pre">	var from = this.remote + this.dataBroker.getURI() + 'fetchJobs';</td></tr><tr class="success"><td>1238</td><td>1</td><td style="border-top:none;white-space:pre">	var response = this.get(from);</td></tr><tr class="success"><td>1239</td><td>1</td><td style="border-top:none;white-space:pre">	var data = this.dataBroker.decode(response);</td></tr><tr class="success"><td>1240</td><td>1</td><td style="border-top:none;white-space:pre">	return data;</td></tr><tr ><td>1241</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>1242</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1243</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>1244</td><td></td><td style="border-top:none;white-space:pre"> * @constructor</td></tr><tr ><td>1245</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>1246</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.Controller = function() {</td></tr><tr class="success"><td>1247</td><td>1</td><td style="border-top:none;white-space:pre">	this.setup();</td></tr><tr ><td>1248</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>1249</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1250</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>1251</td><td></td><td style="border-top:none;white-space:pre"> * Вот тут-то и можно переопределить что угодно</td></tr><tr ><td>1252</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>1253</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.Controller.prototype.setup = function() {</td></tr><tr class="success"><td>1254</td><td>1</td><td style="border-top:none;white-space:pre">	var dataBroker = new Indigo.JsonBroker();</td></tr><tr class="success"><td>1255</td><td>1</td><td style="border-top:none;white-space:pre">	this.messenger = new Indigo.HTTPMessenger(dataBroker);</td></tr><tr ><td>1256</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>1257</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1258</td><td></td><td style="border-top:none;white-space:pre">/** </td></tr><tr ><td>1259</td><td></td><td style="border-top:none;white-space:pre"> * Обработка заданий, основной цикл</td></tr><tr ><td>1260</td><td></td><td style="border-top:none;white-space:pre"> *</td></tr><tr ><td>1261</td><td></td><td style="border-top:none;white-space:pre"> * @param {array} jobs Массив объектов заданий</td></tr><tr ><td>1262</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>1263</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.Controller.prototype.processJobs = function(jobs) {</td></tr><tr class="success"><td>1264</td><td>3</td><td style="border-top:none;white-space:pre">	for (var jb=0, jl = jobs.length; jb < jl; jb++) {</td></tr><tr class="success"><td>1265</td><td>3</td><td style="border-top:none;white-space:pre">		var action = jobs[jb].action;</td></tr><tr class="success"><td>1266</td><td>3</td><td style="border-top:none;white-space:pre">		var data = jobs[jb].data;</td></tr><tr class="success"><td>1267</td><td>3</td><td style="border-top:none;white-space:pre">		var worker = {};</td></tr><tr class="success"><td>1268</td><td>3</td><td style="border-top:none;white-space:pre">		try {</td></tr><tr class="success"><td>1269</td><td>3</td><td style="border-top:none;white-space:pre">			worker = new Indigo[action]();</td></tr><tr ><td>1270</td><td></td><td style="border-top:none;white-space:pre">		} catch (err) {</td></tr><tr class="success"><td>1271</td><td>1</td><td style="border-top:none;white-space:pre">			this.messenger.send('error', { message: 'Invalid action: ' + action });</td></tr><tr class="success"><td>1272</td><td>1</td><td style="border-top:none;white-space:pre">			continue;</td></tr><tr ><td>1273</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr ><td>1274</td><td></td><td style="border-top:none;white-space:pre">		// Светим в messenger в worker</td></tr><tr ><td>1275</td><td></td><td style="border-top:none;white-space:pre">		// worker сможет самостоятельно отправлять _промежуточные_ результаты работы</td></tr><tr class="success"><td>1276</td><td>2</td><td style="border-top:none;white-space:pre">		worker.messenger = this.messenger;</td></tr><tr ><td>1277</td><td></td><td style="border-top:none;white-space:pre">		// Отправить асинхронное уведомление о начале работы над заданием</td></tr><tr class="success"><td>1278</td><td>2</td><td style="border-top:none;white-space:pre">		var feedback = {</td></tr><tr ><td>1279</td><td></td><td style="border-top:none;white-space:pre">			host: $.getenv('computername'),</td></tr><tr ><td>1280</td><td></td><td style="border-top:none;white-space:pre">			info: 'start',</td></tr><tr ><td>1281</td><td></td><td style="border-top:none;white-space:pre">			jobid: data._id,</td></tr><tr ><td>1282</td><td></td><td style="border-top:none;white-space:pre">			source: worker.name,</td></tr><tr ><td>1283</td><td></td><td style="border-top:none;white-space:pre">			user: $.getenv('username') };</td></tr><tr class="success"><td>1284</td><td>2</td><td style="border-top:none;white-space:pre">		this.messenger.send('info', feedback);</td></tr><tr class="success"><td>1285</td><td>2</td><td style="border-top:none;white-space:pre">		var start = new Date().getTime();</td></tr><tr ><td>1286</td><td></td><td style="border-top:none;white-space:pre">		// Запустить worker</td></tr><tr class="success"><td>1287</td><td>2</td><td style="border-top:none;white-space:pre">		try {</td></tr><tr class="success"><td>1288</td><td>2</td><td style="border-top:none;white-space:pre">			worker.setup(data);</td></tr><tr class="success"><td>1289</td><td>2</td><td style="border-top:none;white-space:pre">			feedback.result = worker.run();</td></tr><tr ><td>1290</td><td></td><td style="border-top:none;white-space:pre">			// Затраты по времени в миллисекундах  </td></tr><tr class="success"><td>1291</td><td>1</td><td style="border-top:none;white-space:pre">			feedback.duration = new Date().getTime() - start;</td></tr><tr class="success"><td>1292</td><td>1</td><td style="border-top:none;white-space:pre">			feedback.info = 'finish';</td></tr><tr ><td>1293</td><td></td><td style="border-top:none;white-space:pre">			// Отправить уведомление о результатах работы</td></tr><tr class="success"><td>1294</td><td>1</td><td style="border-top:none;white-space:pre">			this.messenger.send('info', feedback);</td></tr><tr ><td>1295</td><td></td><td style="border-top:none;white-space:pre">		} catch (err) {</td></tr><tr class="success"><td>1296</td><td>1</td><td style="border-top:none;white-space:pre">			this.messenger.send('error', err);</td></tr><tr ><td>1297</td><td></td><td style="border-top:none;white-space:pre">		}</td></tr><tr ><td>1298</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr ><td>1299</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>1300</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr ><td>1301</td><td></td><td style="border-top:none;white-space:pre">/**</td></tr><tr ><td>1302</td><td></td><td style="border-top:none;white-space:pre"> * main()</td></tr><tr ><td>1303</td><td></td><td style="border-top:none;white-space:pre"> */</td></tr><tr class="success"><td>1304</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.Controller.prototype.run = function() {</td></tr><tr class="success"><td>1305</td><td>4</td><td style="border-top:none;white-space:pre">	var jobs = this.messenger.receive('fetchJobs');</td></tr><tr class="success"><td>1306</td><td>4</td><td style="border-top:none;white-space:pre">	if (typeof(jobs) === 'undefined') {</td></tr><tr class="success"><td>1307</td><td>1</td><td style="border-top:none;white-space:pre">		return 'Job fetch error';</td></tr><tr ><td>1308</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr class="success"><td>1309</td><td>3</td><td style="border-top:none;white-space:pre">	if (jobs.length < 1) {</td></tr><tr class="danger"><td>1310</td><td>0</td><td style="border-top:none;white-space:pre">		return 'No Jobs Present';</td></tr><tr ><td>1311</td><td></td><td style="border-top:none;white-space:pre">	} else {</td></tr><tr class="success"><td>1312</td><td>3</td><td style="border-top:none;white-space:pre">		this.processJobs(jobs);</td></tr><tr ><td>1313</td><td></td><td style="border-top:none;white-space:pre">	}</td></tr><tr ><td>1314</td><td></td><td style="border-top:none;white-space:pre">};</td></tr><tr ><td>1315</td><td></td><td style="border-top:none;white-space:pre"></td></tr><tr class="success"><td>1316</td><td>1</td><td style="border-top:none;white-space:pre">Indigo.Controller.prototype.cleanup = function() {</td></tr><tr class="danger"><td>1317</td><td>0</td><td style="border-top:none;white-space:pre">	this.messenger.cleanup();</td></tr></table>
</div>
</body>
</html>